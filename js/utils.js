// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞

// –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
function sanitizeHTML(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–π
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º requestAnimationFrame
function scrollToBottom(element) {
    if (element) {
        requestAnimationFrame(() => {
            element.scrollTop = element.scrollHeight;
        });
    }
}

// –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
function smoothScrollToBottom(element) {
    if (element) {
        element.scrollTo({
            top: element.scrollHeight,
            behavior: 'smooth'
        });
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —á–∞—Ç–∞
function manageChatStorage(messagesContainer, maxMessages = 100) {
    if (!messagesContainer) return;
    const messages = messagesContainer.querySelectorAll('.message');
    if (messages.length > maxMessages) {
        const toRemove = messages.length - maxMessages;
        for (let i = 0; i < toRemove; i++) {
            messages[i].remove();
        }
    }
}

// –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ç–∏
async function withRetry(operation, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await operation();
        } catch (error) {
            console.error(`–ü–æ–ø—ã—Ç–∫–∞ ${i + 1} –Ω–µ —É–¥–∞–ª–∞—Å—å:`, error);
            if (i === maxRetries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞
function exportChat(messagesContainer) {
    const messages = Array.from(messagesContainer.querySelectorAll('.message'));
    const chatText = messages.map(msg => {
        const sender = msg.classList.contains('user-message') ? '–í—ã' : '–ò–ò';
        const content = msg.querySelector('.message-content') ? 
            msg.querySelector('.message-content').textContent : msg.textContent;
        return `${sender}: ${content}`;
    }).join('\n\n');
    
    const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `khuyew-chat-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
function saveChatHistory(messagesContainer) {
    const messages = Array.from(messagesContainer.querySelectorAll('.message')).map(msg => ({
        text: msg.querySelector('.message-content') ? 
            msg.querySelector('.message-content').textContent : msg.textContent,
        isUser: msg.classList.contains('user-message'),
        isError: msg.classList.contains('error-message'),
        isImage: msg.classList.contains('ai-image-message'),
        timestamp: new Date().toISOString()
    }));
    localStorage.setItem('khuyew-chat-history', JSON.stringify(messages));
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
function loadChatHistory(messagesContainer) {
    try {
        const history = localStorage.getItem('khuyew-chat-history');
        if (history) {
            const messages = JSON.parse(history);
            if (messages.length > 0) {
                messages.forEach(msg => {
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    if (!msg.isImage) {
                        addMessage(messagesContainer, msg.text, msg.isUser, msg.isError);
                    }
                });
                return true;
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        localStorage.removeItem('khuyew-chat-history');
    }
    return false;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function addMessage(messagesContainer, text, isUser = false, isError = false) {
    const messageElement = document.createElement('div');
    const className = isError ? 'error-message' : (isUser ? 'user-message' : 'ai-message');
    messageElement.classList.add('message', className);
    
    const contentElement = document.createElement('div');
    contentElement.classList.add('message-content');
    
    if (isUser || isError) {
        contentElement.textContent = sanitizeHTML(text);
    } else {
        // –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –ò–ò –∏—Å–ø–æ–ª—å–∑—É–µ–º Markdown
        contentElement.innerHTML = marked.parse(text);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –¥–ª—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
        contentElement.querySelectorAll('pre code').forEach((block) => {
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –±–ª–æ–∫–∞ –∫–æ–¥–∞ —Å –∫–Ω–æ–ø–∫–æ–π –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            const pre = block.closest('pre');
            const language = block.className.replace('language-', '') || 'text';
            
            const codeHeader = document.createElement('div');
            codeHeader.className = 'code-header';
            
            const languageSpan = document.createElement('span');
            languageSpan.className = 'code-language';
            languageSpan.textContent = language;
            
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.innerHTML = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
            
            copyButton.addEventListener('click', () => {
                const codeText = block.textContent;
                navigator.clipboard.writeText(codeText).then(() => {
                    copyButton.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    copyButton.classList.add('copied');
                    setTimeout(() => {
                        copyButton.innerHTML = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                        copyButton.classList.remove('copied');
                    }, 2000);
                });
            });
            
            codeHeader.appendChild(languageSpan);
            codeHeader.appendChild(copyButton);
            
            pre.insertBefore(codeHeader, block);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
            hljs.highlightElement(block);
        });
    }
    
    messageElement.appendChild(contentElement);
    
    messagesContainer.appendChild(messageElement);
    scrollToBottom(messagesContainer);
    saveChatHistory(messagesContainer);
    manageChatStorage(messagesContainer);
    return messageElement;
}

// –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
function analyzeRequest(message) {
    const imageKeywords = [
        '–Ω–∞—Ä–∏—Å—É–π', '—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π', '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', '–∫–∞—Ä—Ç–∏–Ω–∫—É', '—Ñ–æ—Ç–æ', '–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é',
        'draw', 'generate', 'image', 'picture', 'photo', 'illustration',
        '—Å–æ–∑–¥–∞–π', '–ø–æ–∫–∞–∂–∏', '–≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π', '–∞—Ä—Ç'
    ];
    
    const lowerMessage = message.toLowerCase();
    
    if (imageKeywords.some(keyword => lowerMessage.includes(keyword))) {
        return 'generate';
    } else {
        return 'text';
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π
function initTheme() {
    const savedTheme = localStorage.getItem('khuyew-theme');
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle && savedTheme === 'light') {
        document.body.classList.add('light-theme');
        themeToggle.textContent = '‚òÄÔ∏è';
    }
}

function toggleTheme() {
    const themeToggle = document.getElementById('themeToggle');
    if (!themeToggle) return;
    
    document.body.classList.toggle('light-theme');
    if (document.body.classList.contains('light-theme')) {
        localStorage.setItem('khuyew-theme', 'light');
        themeToggle.textContent = '‚òÄÔ∏è';
    } else {
        localStorage.setItem('khuyew-theme', 'dark');
        themeToggle.textContent = 'üåô';
    }
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function initImageModal() {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const caption = document.getElementById('modalCaption');
    const close = document.querySelector('.close');
    
    if (!modal || !modalImg || !caption || !close) return;
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function openModal(src, alt) {
        modal.style.display = 'block';
        modal.setAttribute('aria-hidden', 'false');
        modalImg.src = src;
        modalImg.alt = alt || '–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
        caption.textContent = alt || '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
        
        // –§–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
        close.focus();
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.body.style.overflow = 'hidden';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeModal() {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–∫—Ä—ã–ª–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const focusedImage = document.querySelector('.generated-image:focus');
        if (focusedImage) {
            focusedImage.focus();
        }
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    close.addEventListener('click', closeModal);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('generated-image')) {
            openModal(e.target.src, e.target.alt);
        }
    });
    
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    document.addEventListener('keydown', (e) => {
        if (e.target.classList.contains('generated-image') && (e.key === 'Enter' || e.key === ' ')) {
            e.preventDefault();
            openModal(e.target.src, e.target.alt);
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ–∫—É—Å–æ–º –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.addEventListener('keydown', (e) => {
        if (modal.style.display === 'block') {
            if (e.key === 'Escape') {
                closeModal();
            } else if (e.key === 'Tab') {
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const focusableElements = modal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];
                
                if (e.shiftKey && document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                } else if (!e.shiftKey && document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        }
    });
}
