class KHAIAssistant{constructor(){this.currentChatId=null;this.chats=this.loadChats();this.currentModel='gpt-5-nano';this.isGenerating=false;this.attachedFiles=[];this.currentMode='normal';this.isRecording=false;this.recognition=null;this.puter=null;this.init()}init(){this.initTheme();this.initEventListeners();this.initPuter();this.initVoiceRecognition();this.loadCurrentChat();this.hidePreloader();setTimeout(()=>{this.showNotification('KHAI Assistant загружен!','success')},1000)}initTheme(){const savedTheme=localStorage.getItem('khai-theme')||'dark';document.documentElement.setAttribute('data-theme',savedTheme);this.updateThemeIcon(savedTheme)}initEventListeners(){document.getElementById('themeToggle').addEventListener('click',()=>this.toggleTheme());document.getElementById('themeMinimapToggle').addEventListener('click',()=>this.toggleTheme());document.getElementById('menuToggle').addEventListener('click',()=>this.toggleSidebar());document.getElementById('sidebarClose').addEventListener('click',()=>this.toggleSidebar());document.getElementById('sidebarOverlay').addEventListener('click',()=>this.toggleSidebar());document.getElementById('logoBtn').addEventListener('click',()=>this.toggleSidebar());document.getElementById('newChatBtn').addEventListener('click',()=>this.createNewChat());document.getElementById('clearChatBtn').addEventListener('click',()=>this.clearCurrentChat());document.getElementById('sendBtn').addEventListener('click',()=>this.sendMessage());document.getElementById('userInput').addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();this.sendMessage()}});document.getElementById('userInput').addEventListener('input',(e)=>this.handleInputChange(e));document.getElementById('clearInputBtn').addEventListener('click',()=>this.clearInput());document.getElementById('voiceInputBtn').addEventListener('click',()=>this.toggleVoiceInput());document.getElementById('attachFileBtn').addEventListener('click',()=>document.getElementById('fileInput').click());document.getElementById('fileInput').addEventListener('change',(e)=>this.handleFileSelect(e));document.getElementById('normalModeBtn').addEventListener('click',()=>this.setMode('normal'));document.getElementById('generateVoiceBtn').addEventListener('click',()=>this.setMode('voice'));document.getElementById('generateImageBtn').addEventListener('click',()=>this.setMode('image'));document.getElementById('modelSelectBtn').addEventListener('click',()=>this.showModelSelection());document.getElementById('scrollToBottom').addEventListener('click',()=>this.scrollToBottom());document.getElementById('scrollToLastAI').addEventListener('click',()=>this.scrollToLastAIMessage());document.getElementById('downloadChatBtn').addEventListener('click',()=>this.downloadChat());document.getElementById('deleteAllChatsBtn').addEventListener('click',()=>this.deleteAllChats());document.getElementById('importChatBtn').addEventListener('click',()=>this.importChat());document.getElementById('helpBtn').addEventListener('click',()=>this.showHelp());document.getElementById('errorBackBtn').addEventListener('click',()=>this.hide404Page());this.initSearch();this.initModals();this.initMinimap()}initPuter(){this.puter=window.puter;}initVoiceRecognition(){if('webkitSpeechRecognition'in window||'SpeechRecognition'in window){const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new SpeechRecognition();this.recognition.continuous=false;this.recognition.interimResults=true;this.recognition.lang='ru-RU';this.recognition.onresult=(event)=>{const transcript=Array.from(event.results).map(result=>result[0].transcript).join('');document.getElementById('userInput').value=transcript;this.handleInputChange()};this.recognition.onend=()=>{this.isRecording=false;this.updateVoiceButton()}}}initSearch(){const headerSearch=document.getElementById('headerSearch');const sidebarSearch=document.getElementById('sidebarSearch');const headerSearchClear=document.getElementById('headerSearchClear');const sidebarSearchClear=document.getElementById('sidebarSearchClear');headerSearch.addEventListener('input',(e)=>this.handleHeaderSearch(e.target.value));sidebarSearch.addEventListener('input',(e)=>this.handleSidebarSearch(e.target.value));headerSearchClear.addEventListener('click',()=>{headerSearch.value='';this.handleHeaderSearch('');headerSearchClear.style.display='none'});sidebarSearchClear.addEventListener('click',()=>{sidebarSearch.value='';this.handleSidebarSearch('');sidebarSearchClear.style.display='none'})}initModals(){this.initEditChatModal();this.initModelSelectionModal()}initEditChatModal(){const modal=document.getElementById('editChatModal');const closeBtn=document.getElementById('editChatModalClose');const cancelBtn=document.getElementById('editChatModalCancel');const saveBtn=document.getElementById('editChatModalSave');const clearBtn=document.getElementById('modalClearInput');const input=document.getElementById('editChatNameInput');[closeBtn,cancelBtn].forEach(btn=>{btn.addEventListener('click',()=>this.hideModal(modal))});saveBtn.addEventListener('click',()=>{const newName=input.value.trim();if(newName){this.renameCurrentChat(newName);this.hideModal(modal)}});input.addEventListener('input',(e)=>{clearBtn.style.display=e.target.value?'flex':'none'});clearBtn.addEventListener('click',()=>{input.value='';clearBtn.style.display='none'})}initModelSelectionModal(){const modal=document.getElementById('modelModalOverlay');const closeBtn=document.getElementById('modelModalClose');const cancelBtn=document.getElementById('modelModalCancel');const confirmBtn=document.getElementById('modelModalConfirm');[closeBtn,cancelBtn].forEach(btn=>{btn.addEventListener('click',()=>this.hideModal(modal))});confirmBtn.addEventListener('click',()=>{const selectedModel=document.querySelector('.model-item.selected');if(selectedModel){this.currentModel=selectedModel.dataset.model;this.updateModelInfo();this.hideModal(modal);this.showNotification(`Модель изменена на ${selectedModel.dataset.name}`,'success')}});this.populateModelList()}initMinimap(){const minimap=document.getElementById('chatMinimap');const viewport=document.getElementById('minimapViewport');const messagesContainer=document.getElementById('messagesContainer');let isDragging=false;minimap.addEventListener('mousedown',(e)=>{isDragging=true;this.handleMinimapClick(e)});document.addEventListener('mousemove',(e)=>{if(isDragging){this.handleMinimapClick(e)}});document.addEventListener('mouseup',()=>{isDragging=false});messagesContainer.addEventListener('scroll',()=>this.updateMinimapViewport())}toggleTheme(){const currentTheme=document.documentElement.getAttribute('data-theme');const newTheme=currentTheme==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',newTheme);localStorage.setItem('khai-theme',newTheme);this.updateThemeIcon(newTheme)}updateThemeIcon(theme){const icons=document.querySelectorAll('#themeToggle i, #themeMinimapToggle i');icons.forEach(icon=>{icon.className=theme==='dark'?'ti ti-moon':'ti ti-sun'})}toggleSidebar(){const sidebar=document.getElementById('sidebarMenu');const overlay=document.getElementById('sidebarOverlay');sidebar.classList.toggle('active');overlay.classList.toggle('active')}createNewChat(){const chatId='chat_'+Date.now();const chat={id:chatId,name:'Новый чат',messages:[],createdAt:new Date().toISOString()};this.chats.unshift(chat);this.saveChats();this.switchToChat(chatId);this.toggleSidebar()}clearCurrentChat(){if(confirm('Вы уверены, что хотите очистить текущий чат?')){const chat=this.chats.find(c=>c.id===this.currentChatId);if(chat){chat.messages=[];this.saveChats();this.renderMessages();this.showNotification('Чат очищен','success')}}}async sendMessage(){const input=document.getElementById('userInput');const message=input.value.trim();if((!message&&this.attachedFiles.length===0)||this.isGenerating)return;this.addMessage('user',message,this.attachedFiles);input.value='';this.clearInput();this.attachedFiles=[];this.updateAttachedFiles();this.isGenerating=true;this.showTypingIndicator();try{let response;switch(this.currentMode){case'voice':response=await this.generateVoiceResponse(message);break;case'image':response=await this.generateImageResponse(message);break;default:response=await this.generateTextResponse(message);}this.hideTypingIndicator();this.addMessage('ai',response);this.scrollToBottom()}catch(error){this.hideTypingIndicator();this.handleError(error)}this.isGenerating=false}async generateTextResponse(message){try{const response=await fetch('https://api.puter.com/v2/ai/chat/completions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:this.currentModel,messages:[{role:'user',content:message}],stream:false})});const data=await response.json();return data.choices[0].message.content||'Извините, произошла ошибка.'}catch(error){console.error('API Error:',error);return'Извините, сервис временно недоступен. Попробуйте позже.'}}async generateVoiceResponse(message){return`🔊 Голосовой ответ для: "${message}"\n\nЭта функция находится в разработке и будет доступна в ближайшем обновлении.`}async generateImageResponse(message){return`🎨 Изображение для: "${message}"\n\n![Генерируемое изображение](${await this.generatePlaceholderImage(message)})\n\nОписание: ${message}`}async generatePlaceholderImage(text){return`https://via.placeholder.com/512/0f0f23/0099ff?text=${encodeURIComponent(text.substring(0,20))}`}addMessage(role,content,files=[]){if(!this.currentChatId)this.createNewChat();const chat=this.chats.find(c=>c.id===this.currentChatId);if(chat){const message={id:'msg_'+Date.now(),role,content,timestamp:new Date().toISOString(),files};chat.messages.push(message);chat.lastActivity=new Date().toISOString();this.saveChats();this.renderMessages();this.updateMinimap();return message}}renderMessages(){const container=document.getElementById('messagesContainer');container.innerHTML='';const chat=this.chats.find(c=>c.id===this.currentChatId);if(chat&&chat.messages.length>0){chat.messages.forEach(message=>{const messageEl=this.createMessageElement(message);container.appendChild(messageEl)})}else{this.showWelcomeMessage()}this.scrollToBottom()}createMessageElement(message){const messageEl=document.createElement('div');messageEl.className=`message message-${message.role}`;messageEl.dataset.messageId=message.id;let content=message.content;if(message.role==='ai'){content=marked.parse(content);}else{content=this.escapeHtml(content).replace(/\n/g,'<br>');}messageEl.innerHTML=`<div class="message-content">${content}</div>`;if(message.files&&message.files.length>0){const filesHtml=message.files.map(file=>`<div class="file-item"><i class="ti ti-file"></i><span class="file-name">${this.escapeHtml(file.name)}</span></div>`).join('');messageEl.querySelector('.message-content').innerHTML+=`<div class="attached-files">${filesHtml}</div>`;}return messageEl}showWelcomeMessage(){const container=document.getElementById('messagesContainer');container.innerHTML=`<div class="message message-ai welcome-message"><div class="message-content"><h3>👋 Добро пожаловать в KHAI Assistant!</h3><p>Я — первый белорусский ИИ-помощник. Вот что я умею:</p><ul><li>💬 Отвечать на вопросы и помогать с задачами</li><li>🎨 Генерировать изображения по описанию</li><li>🔊 Создавать голосовые сообщения</li><li>📁 Анализировать прикрепленные файлы</li><li>💻 Помогать с программированием</li></ul><p>Выберите режим работы ниже и начните общение!</p></div></div>`;}showTypingIndicator(){const container=document.getElementById('messagesContainer');const typingEl=document.createElement('div');typingEl.className='typing-indicator';typingEl.innerHTML=`<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;container.appendChild(typingEl);this.scrollToBottom()}hideTypingIndicator(){const typingEl=document.querySelector('.typing-indicator');if(typingEl)typingEl.remove()}handleInputChange(){const input=document.getElementById('userInput');const clearBtn=document.getElementById('clearInputBtn');clearBtn.style.display=input.value.trim()?'flex':'none';this.autoResizeTextarea(input)}autoResizeTextarea(textarea){textarea.style.height='auto';textarea.style.height=Math.min(textarea.scrollHeight,120)+'px'}clearInput(){const input=document.getElementById('userInput');input.value='';input.style.height='auto';document.getElementById('clearInputBtn').style.display='none'}toggleVoiceInput(){if(!this.recognition){this.showNotification('Голосовой ввод не поддерживается в вашем браузере','warning');return}if(this.isRecording){this.recognition.stop();}else{this.recognition.start();this.isRecording=true;this.updateVoiceButton()}}updateVoiceButton(){const btn=document.getElementById('voiceInputBtn');const icon=btn.querySelector('i');if(this.isRecording){icon.className='ti ti-square';btn.style.color='var(--error-text)';}else{icon.className='ti ti-microphone';btn.style.color='var(--text-secondary)'}}handleFileSelect(event){const files=Array.from(event.target.files);files.forEach(file=>{if(file.size>10*1024*1024){this.showNotification(`Файл ${file.name} слишком большой (макс. 10MB)`,'error');return}this.attachedFiles.push(file)});this.updateAttachedFiles();event.target.value=''}updateAttachedFiles(){const container=document.getElementById('attachedFiles');container.innerHTML='';this.attachedFiles.forEach((file,index)=>{const fileEl=document.createElement('div');fileEl.className='file-item';fileEl.innerHTML=`<i class="ti ti-file"></i><span class="file-name">${this.escapeHtml(file.name)}</span><button class="file-remove" data-index="${index}"><i class="ti ti-x"></i></button>`;container.appendChild(fileEl)});container.querySelectorAll('.file-remove').forEach(btn=>{btn.addEventListener('click',(e)=>{const index=parseInt(e.currentTarget.dataset.index);this.attachedFiles.splice(index,1);this.updateAttachedFiles()})})}setMode(mode){this.currentMode=mode;document.querySelectorAll('.mode-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById(mode+'ModeBtn').classList.add('active');const modeText=mode==='normal'?'Обычный':mode==='voice'?'Голос':'Изображения';document.querySelector('.mode-indicator').innerHTML=`<i class="ti ti-${this.getModeIcon(mode)}"></i> ${modeText} режим`;this.showNotification(`${modeText} режим активирован`,'success')}getModeIcon(mode){const icons={normal:'message',voice:'microphone',image:'photo'};return icons[mode]}showModelSelection(){this.showModal(document.getElementById('modelModalOverlay'))}populateModelList(){const container=document.getElementById('modelList');const models=[{id:'gpt-5-nano',name:'GPT-5 Nano',description:'Быстрая и эффективная',status:'Рекомендуется'},{id:'deepseek-v3',name:'DeepSeek V3',description:'Многоязычная модель',status:'Доступно'},{id:'gemini-ultra',name:'Gemini Ultra',description:'Продвинутые возможности',status:'Бета'},{id:'claude-3-opus',name:'Claude 3 Opus',description:'Творческие задачи',status:'Доступно'}];container.innerHTML=models.map(model=>`<div class="model-item ${model.id===this.currentModel?'selected':''}" data-model="${model.id}" data-name="${model.name}"><div class="model-icon"><i class="ti ti-brain"></i></div><div class="model-info"><div class="model-name">${model.name}</div><div class="model-desc">${model.description}</div></div><div class="model-status">${model.status}</div></div>`).join('');container.querySelectorAll('.model-item').forEach(item=>{item.addEventListener('click',()=>{container.querySelectorAll('.model-item').forEach(i=>i.classList.remove('selected'));item.classList.add('selected')})})}updateModelInfo(){document.getElementById('currentModelInfo').textContent=this.getModelName(this.currentModel)}getModelName(id){const models={'gpt-5-nano':'GPT-5 Nano','deepseek-v3':'DeepSeek V3','gemini-ultra':'Gemini Ultra','claude-3-opus':'Claude 3 Opus'};return models[id]||id}scrollToBottom(){const container=document.getElementById('messagesContainer');container.scrollTop=container.scrollHeight}scrollToLastAIMessage(){const messages=document.querySelectorAll('.message-ai');if(messages.length>0){const lastMessage=messages[messages.length-1];lastMessage.scrollIntoView({behavior:'smooth',block:'center'})}}updateMinimap(){const container=document.getElementById('minimapContent');const messages=document.querySelectorAll('.message');container.innerHTML='';messages.forEach((message,index)=>{const dot=document.createElement('div');dot.className=`minimap-message ${message.classList.contains('message-user')?'user':'ai'}`;dot.title=`Сообщение ${index+1}`;dot.addEventListener('click',()=>{message.scrollIntoView({behavior:'smooth',block:'center'})});container.appendChild(dot)})}updateMinimapViewport(){const messagesContainer=document.getElementById('messagesContainer');const viewport=document.getElementById('minimapViewport');const minimap=document.getElementById('chatMinimap');const content=document.getElementById('minimapContent');const containerHeight=messagesContainer.scrollHeight;const visibleHeight=messagesContainer.clientHeight;const scrollTop=messagesContainer.scrollTop;const viewportHeight=(visibleHeight/containerHeight)*minimap.clientHeight;const viewportTop=(scrollTop/containerHeight)*minimap.clientHeight;viewport.style.height=viewportHeight+'px';viewport.style.top=viewportTop+'px'}handleMinimapClick(event){const minimap=document.getElementById('chatMinimap');const messagesContainer=document.getElementById('messagesContainer');const rect=minimap.getBoundingClientRect();const clickY=event.clientY-rect.top;const percentage=clickY/rect.height;const targetScroll=percentage*messagesContainer.scrollHeight;messagesContainer.scrollTop=targetScroll- messagesContainer.clientHeight/2}showModal(modal){modal.classList.add('active')}hideModal(modal){modal.classList.remove('active')}showNotification(message,type='success'){const notification=document.createElement('div');notification.className=`notification ${type}`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{notification.remove()},3000)}handleError(error){console.error('Error:',error);this.showNotification('Произошла ошибка. Попробуйте еще раз.','error')}escapeHtml(unsafe){return unsafe.replace(/[&<"'>]/g,function(m){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]})}loadChats(){try{const saved=localStorage.getItem('khai-chats');if(saved){return JSON.parse(saved)}}catch(e){console.error('Error loading chats:',e)}return[]}saveChats(){try{localStorage.setItem('khai-chats',JSON.stringify(this.chats));this.renderChatList()}catch(e){console.error('Error saving chats:',e)}}loadCurrentChat(){if(this.chats.length===0){this.createNewChat();}else{this.switchToChat(this.chats[0].id)}}switchToChat(chatId){this.currentChatId=chatId;this.renderMessages();this.updateChatInfo();this.renderChatList()}renderChatList(){const container=document.getElementById('chatList');container.innerHTML=this.chats.map(chat=>`<div class="chat-item ${chat.id===this.currentChatId?'active':''}" data-chat-id="${chat.id}"><div class="chat-item-content"><div class="chat-item-name">${this.escapeHtml(chat.name)}</div><div class="chat-item-date">${this.formatDate(chat.lastActivity||chat.createdAt)}</div></div><div class="chat-item-actions"><button class="chat-action-btn edit-chat-btn" title="Редактировать"><i class="ti ti-edit"></i></button><button class="chat-action-btn delete-chat-btn" title="Удалить"><i class="ti ti-trash"></i></button></div></div>`).join('');container.querySelectorAll('.chat-item').forEach(item=>{item.addEventListener('click',(e)=>{if(!e.target.closest('.chat-item-actions')){this.switchToChat(item.dataset.chatId);this.toggleSidebar()}})});container.querySelectorAll('.edit-chat-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{e.stopPropagation();const chatId=e.target.closest('.chat-item').dataset.chatId;this.showEditChatModal(chatId)})});container.querySelectorAll('.delete-chat-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{e.stopPropagation();const chatId=e.target.closest('.chat-item').dataset.chatId;this.deleteChat(chatId)})})}showEditChatModal(chatId){const chat=this.chats.find(c=>c.id===chatId);if(chat){const input=document.getElementById('editChatNameInput');input.value=chat.name;this.showModal(document.getElementById('editChatModal'));input.focus()}}renameCurrentChat(newName){const chat=this.chats.find(c=>c.id===this.currentChatId);if(chat){chat.name=newName;this.saveChats();this.updateChatInfo();this.showNotification('Название чата изменено','success')}}deleteChat(chatId){if(confirm('Вы уверены, что хотите удалить этот чат?')){this.chats=this.chats.filter(c=>c.id!==chatId);this.saveChats();if(this.currentChatId===chatId){if(this.chats.length>0){this.switchToChat(this.chats[0].id)}else{this.createNewChat()}}this.showNotification('Чат удален','success')}}deleteAllChats(){if(confirm('Вы уверены, что хотите удалить ВСЕ чаты? Это действие нельзя отменить.')){this.chats=[];this.saveChats();this.createNewChat();this.showNotification('Все чаты удалены','success')}}updateChatInfo(){const chat=this.chats.find(c=>c.id===this.currentChatId);if(chat){document.getElementById('currentChatName').textContent=chat.name}}formatDate(dateString){const date=new Date(dateString);const now=new Date();const diff=now-date;if(diff<60000)return'Только что';if(diff<3600000)return Math.floor(diff/60000)+' мин назад';if(diff<86400000)return Math.floor(diff/3600000)+' ч назад';return date.toLocaleDateString('ru-RU')}downloadChat(){const chat=this.chats.find(c=>c.id===this.currentChatId);if(!chat)return;const content=chat.messages.map(msg=>`${msg.role==='user'?'Вы':'KHAI'}: ${msg.content}`).join('\n\n');const blob=new Blob([content],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`khai-chat-${new Date().toISOString().split('T')[0]}.txt`;a.click();URL.revokeObjectURL(url);this.showNotification('Чат скачан','success')}importChat(){const input=document.createElement('input');input.type='file';input.accept='.txt,.json';input.onchange=(e)=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=(e)=>{try{const content=e.target.result;this.createNewChat();const currentChat=this.chats.find(c=>c.id===this.currentChatId);if(currentChat){currentChat.name=`Импорт: ${file.name.split('.')[0]}`;const lines=content.split('\n');lines.forEach(line=>{if(line.trim()){const parts=line.split(':');if(parts.length>=2){const role=parts[0].trim().toLowerCase()==='вы'?'user':'ai';const content=parts.slice(1).join(':').trim();if(content){currentChat.messages.push({id:'msg_'+Date.now(),role,content,timestamp:new Date().toISOString()})}}}});this.saveChats();this.renderMessages();this.showNotification('Чат импортирован','success')}}catch(error){this.showNotification('Ошибка импорта файла','error')}};reader.readAsText(file)};input.click()}handleHeaderSearch(query){const messages=document.querySelectorAll('.message');messages.forEach(msg=>{const content=msg.querySelector('.message-content').textContent.toLowerCase();msg.style.display=content.includes(query.toLowerCase())?'block':'none'})}handleSidebarSearch(query){const chatItems=document.querySelectorAll('.chat-item');chatItems.forEach(item=>{const name=item.querySelector('.chat-item-name').textContent.toLowerCase();item.style.display=name.includes(query.toLowerCase())?'block':'none'})}showHelp(){this.showNotification('📚 Откройте меню для доступа к настройкам и истории чатов','info')}hidePreloader(){setTimeout(()=>{const preloader=document.getElementById('preloader');preloader.classList.add('fade-out');setTimeout(()=>preloader.style.display='none',500)},1000)}show404Page(){document.getElementById('appContainer').style.display='none';document.getElementById('page404').style.display='flex'}hide404Page(){document.getElementById('appContainer').style.display='flex';document.getElementById('page404').style.display='none'}}document.addEventListener('DOMContentLoaded',()=>{new KHAIAssistant()});if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js').then(()=>console.log('Service Worker registered')).catch(err=>console.log('Service Worker registration failed:',err))}
