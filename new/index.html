<!DOCTYPE html>
<html lang="ru" itemscope itemtype="https://schema.org/WebApplication">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0f0f23">
    
    <!-- Critical Performance Optimizations -->
    <link rel="preload" href="./logo.png" as="image" type="image/png">
    <link rel="preload" href="./styles.css" as="style">
    <link rel="preload" href="./script.js" as="script" crossorigin="anonymous">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://js.puter.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- Critical CSS Inline -->
    <style>
        .preloader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #0f0f23; display: flex; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .preloader.fade-out { opacity: 0; visibility: hidden; }
        .preloader-content { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .preloader-logo { width: 80px; height: 80px; object-fit: contain; animation: float 3s ease-in-out infinite; }
        .preloader-spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.15); border-top: 4px solid #0099ff; border-radius: 50%; animation: spin 1s linear infinite; }
        .preloader-text { color: #a0a0c0; font-size: 14px; margin-top: 10px; }
        .app-container { opacity: 1; contain: layout style paint; }
        .messages-container { content-visibility: auto; contain-intrinsic-size: 400px; }
        .message { content-visibility: auto; contain-intrinsic-size: 100px; }
        .logo, .control-btn, .model-select-btn { width: 36px !important; height: 36px !important; flex-shrink: 0; }
        @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <!-- SEO Meta Tags -->
    <title>KHAI — Первый белорусский ИИ-помощник | Бесплатный AI чат</title>
    <meta name="description" content="KHAI — первый белорусский ИИ-ассистент с генерацией изображений и голоса. Бесплатный AI-чат с поддержкой файлов и мультиязычным интерфейсом">
    <meta name="keywords" content="KHAI, белорусский ИИ, искусственный интеллект, AI помощник, чат с ИИ, генерация изображений, голосовой ИИ, ИИ Беларусь">
    <meta name="author" content="KHAI Team">
    <meta name="robots" content="index, follow, max-image-preview:large">
    <meta name="googlebot" content="index, follow">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="KHAI Assistant">
    <meta property="og:title" content="KHAI — Первый белорусский ИИ-помощник">
    <meta property="og:description" content="Бесплатный ИИ-ассистент с генерацией изображений и голоса. Анализ файлов, написание кода, мультиязычная поддержка">
    <meta property="og:image" content="./logo.png">
    <meta property="og:url" content="./">
    <meta property="og:locale" content="ru_RU">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="KHAI — Первый белорусский ИИ-помощник">
    <meta name="twitter:description" content="Бесплатный ИИ-ассистент с генерацией изображений и голоса">
    <meta name="twitter:image" content="./logo.png">
    <meta name="twitter:site" content="@khai_assistant">
    
    <!-- Schema.org -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "KHAI Assistant",
        "url": "./",
        "description": "Первый белорусский ИИ-помощник с генерацией изображений и голоса",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Any",
        "permissions": "microphone",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "author": {
            "@type": "Organization",
            "name": "KHAI",
            "url": "./"
        }
    }
    </script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json" crossorigin="use-credentials">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="apple-touch-icon" href="./logo.png">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css"></noscript>
    
    <!-- Styles -->
    <link rel="stylesheet" href="./styles.css" media="print" onload="this.media='all'">
    
    <!-- Puter AI SDK -->
    <script src="https://js.puter.com/v2/" defer></script>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader" id="preloader">
        <div class="preloader-content">
            <img src="./logo.png" alt="KHAI" class="preloader-logo" fetchpriority="high" width="80" height="80">
            <div class="preloader-spinner"></div>
            <p class="preloader-text">Загрузка KHAI Assistant...</p>
        </div>
    </div>

    <!-- 404 Page (hidden by default) -->
    <div class="page-404" id="page404" style="display: none;">
        <div class="error-container">
            <img src="./logo.png" alt="KHAI" class="error-logo" width="120" height="120">
            <h1>404 - Страница не найдена</h1>
            <p>Запрошенная страница не существует или была перемещена.</p>
            <button class="error-btn" id="errorBackBtn">Вернуться в приложение</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo" id="logoBtn">
                        <img src="./logo.png" alt="KHAI Assistant" width="36" height="36" loading="eager" fetchpriority="high" style="aspect-ratio: 1/1;" onerror="this.style.display='none'">
                    </div>
                </div>
                
                <button class="control-btn model-select-btn" id="modelSelectBtn" title="Выбрать модель ИИ">
                    <i class="ti ti-brain"></i>
                </button>
                
                <div class="header-search-container">
                    <div class="search-wrapper">
                        <i class="ti ti-search"></i>
                        <input type="text" id="headerSearch" placeholder="Поиск по чату..." aria-label="Поиск по истории чата">
                        <button class="search-clear" id="headerSearchClear" style="display: none;" aria-label="Очистить поиск">
                            <i class="ti ti-x"></i>
                        </button>
                    </div>
                </div>
                
                <div class="header-controls">
                    <button class="control-btn" id="themeToggle" aria-label="Переключить тему">
                        <i class="ti ti-moon"></i>
                    </button>
                    <button class="control-btn menu-toggle" id="menuToggle" aria-label="Открыть меню">
                        <i class="ti ti-menu-2"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div class="messages-container" id="messagesContainer" aria-live="polite">
                <!-- Skeleton loading messages with stable layout -->
                <div class="message-skeleton" style="height: 80px; margin-bottom: 16px;">
                    <div class="skeleton-avatar" style="width: 32px; height: 32px;"></div>
                    <div class="skeleton-content" style="height: 48px;">
                        <div class="skeleton-line" style="height: 12px; margin-bottom: 8px;"></div>
                        <div class="skeleton-line" style="height: 12px; width: 70%;"></div>
                    </div>
                </div>
                <div class="message-skeleton user" style="height: 60px; margin-bottom: 16px;">
                    <div class="skeleton-content" style="height: 40px;">
                        <div class="skeleton-line" style="height: 12px; width: 60%; margin-bottom: 8px;"></div>
                        <div class="skeleton-line" style="height: 12px; width: 40%;"></div>
                    </div>
                    <div class="skeleton-avatar" style="width: 32px; height: 32px;"></div>
                </div>
            </div>

            <!-- Minimap & Navigation -->
            <div class="chat-minimap-container">
                <div class="minimap-header">
                    <button class="nav-btn theme-minimap-btn" id="themeMinimapToggle" title="Переключить тему">
                        <i class="ti ti-moon"></i>
                    </button>
                </div>
                <div class="chat-minimap" id="chatMinimap">
                    <div class="minimap-content" id="minimapContent"></div>
                    <div class="minimap-viewport" id="minimapViewport"></div>
                </div>
                <div class="minimap-navigation">
                    <button class="nav-btn" id="scrollToLastAI" title="К последнему ответу ИИ">
                        <i class="ti ti-arrow-up"></i>
                    </button>
                    <button class="nav-btn" id="scrollToBottom" title="К низу чата">
                        <i class="ti ti-arrow-down"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- Input Section -->
        <div class="input-section" id="inputSection">
            <div class="mode-indicator">
                <i class="ti ti-message"></i> Обычный режим
            </div>
            
            <div class="input-wrapper">
                <button class="attach-btn" id="attachFileBtn" title="Прикрепить файл">
                    <i class="ti ti-plus"></i>
                    <input type="file" id="fileInput" accept="image/*,.txt,.md,.html,.css,.js,.json,.py,.java,.cpp,.c,.cs,.php,.rb,.go,.swift,.kt,.scala,.rs,.xml,.csv,.yaml,.yml" multiple style="display: none;">
                </button>
                
                <textarea 
                    id="userInput" 
                    placeholder="Задайте вопрос или опишите изображение..." 
                    autocomplete="off" 
                    rows="1"
                    maxlength="4000"
                    aria-label="Поле ввода сообщения"
                ></textarea>
                
                <div class="input-controls">
                    <button class="input-btn" id="clearInputBtn" title="Очистить ввод" style="display: none;">
                        <i class="ti ti-x"></i>
                    </button>
                    <button class="input-btn" id="voiceInputBtn" title="Голосовой ввод">
                        <i class="ti ti-microphone"></i>
                    </button>
                    <button class="send-btn" id="sendBtn" title="Отправить сообщение">
                        <i class="ti ti-send"></i>
                    </button>
                </div>
            </div>

            <div class="attached-files" id="attachedFiles"></div>

            <div class="action-buttons">
                <button class="action-btn mode-btn active" id="normalModeBtn">
                    <i class="ti ti-message"></i>
                    <span class="btn-text">Обычный</span>
                </button>
                <button class="action-btn mode-btn" id="generateVoiceBtn">
                    <i class="ti ti-microphone"></i>
                    <span class="btn-text">Голос</span>
                </button>
                <button class="action-btn mode-btn" id="generateImageBtn" disabled title="В разработке">
                    <i class="ti ti-photo"></i>
                    <span class="btn-text">Изображения</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                <div class="current-chat-info">
                    <i class="ti ti-message"></i>
                    <span id="currentChatName">Новый чат</span>
                </div>
                
                <div class="connection-status">
                    <i class="ti ti-circle"></i>
                    <span id="connectionStatusText">Подключено</span>
                </div>
                
                <div class="footer-controls">
                    <button class="footer-btn" id="helpBtn" title="Помощь">
                        <i class="ti ti-help"></i>
                    </button>
                    <button class="footer-btn" id="downloadChatBtn" title="Скачать чат">
                        <i class="ti ti-download"></i>
                    </button>
                    <button class="footer-btn" id="clearChatBtn" title="Очистить чат">
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Sidebar Menu -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="sidebar-menu" id="sidebarMenu">
        <div class="sidebar-header">
            <div class="sidebar-header-content">
                <div class="sidebar-logo">
                    <img src="./icon.png" alt="KHAI" loading="lazy" width="40" height="40">
                </div>
                <h3>KHAI <span class="beta-badge">BETA</span></h3>
            </div>
            <button class="sidebar-close" id="sidebarClose">
                <i class="ti ti-x"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <div class="sidebar-search-container">
                <div class="search-wrapper">
                    <i class="ti ti-search"></i>
                    <input type="text" id="sidebarSearch" placeholder="Поиск по чатам..." aria-label="Поиск по чатам">
                    <button class="search-clear" id="sidebarSearchClear" style="display: none;" aria-label="Очистить поиск">
                        <i class="ti ti-x"></i>
                    </button>
                </div>
            </div>

            <div class="sidebar-section">
                <h4><i class="ti ti-messages"></i> Мои чаты</h4>
                <div class="chat-list" id="chatList"></div>
                <div class="chat-management-buttons">
                    <button class="sidebar-btn primary" id="newChatBtn">
                        <i class="ti ti-plus"></i> Новый чат
                    </button>
                    <button class="sidebar-btn" id="importChatBtn">
                        <i class="ti ti-upload"></i> Импорт чата
                    </button>
                    <button class="sidebar-btn danger" id="deleteAllChatsBtn">
                        <i class="ti ti-trash"></i> Удалить все
                    </button>
                </div>
            </div>

            <div class="sidebar-section">
                <h4><i class="ti ti-brain"></i> Модель ИИ</h4>
                <div class="current-model-info">
                    <span id="currentModelInfo">GPT-5 Nano</span>
                    <span class="connection-status" id="connectionStatus">✅ Онлайн</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h4><i class="ti ti-info-circle"></i> О приложении</h4>
                <div class="about-content">
                    <div class="about-item">
                        <strong>KHAI Assistant</strong>
                        <span>Первый белорусский ИИ-помощник</span>
                    </div>
                    <div class="about-item">
                        <strong>Версия</strong>
                        <span>2.1.0</span>
                    </div>
                    <div class="about-item">
                        <strong>Обновлено</strong>
                        <span id="appVersionDate">2024</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-links" style="margin-top: auto; padding: 20px 0; text-align: center;">
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                    <a href="https://khai.by/docs" target="_blank" style="color: var(--text-secondary); text-decoration: none; font-size: 13px; transition: var(--transition);">
                        Документация
                    </a>
                    <a href="https://khai.by/support" target="_blank" style="color: var(--text-secondary); text-decoration: none; font-size: 13px; transition: var(--transition);">
                        Поддержка
                    </a>
                    <a href="mailto:khuyew@proton.me" style="color: var(--text-secondary); text-decoration: none; font-size: 13px; transition: var(--transition);">
                        Сотрудничество
                    </a>
                </div>
                
                <!-- LiveInternet Counter -->
                <div style="margin-bottom: 20px; display: flex; justify-content: center;">
                    <!--LiveInternet counter--><a href="https://www.liveinternet.ru/click"
                    target="_blank"><img id="licntB611" width="88" height="31" style="border:0" 
                    title="LiveInternet: показано число просмотров и посетителей за 24 часа"
                    src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAEALAAAAAABAAEAAAIBTAA7"
                    alt=""/></a><script>(function(d,s){d.getElementById("licntB611").src=
                    "https://counter.yadro.ru/hit?t52.6;r"+escape(d.referrer)+
                    ((typeof(s)=="undefined")?"":";s"+s.width+"*"+s.height+"*"+
                    (s.colorDepth?s.colorDepth:s.pixelDepth))+";u"+escape(d.URL)+
                    ";h"+escape(d.title.substring(0,150))+";"+Math.random()})
                    (document,screen)</script><!--/LiveInternet-->
                </div>
                
                <a href="https://khai.by/github" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: var(--radius-md); transition: var(--transition); margin-bottom: 20px;">
                    <i class="ti ti-brand-github" style="font-size: 20px; color: var(--text-secondary);"></i>
                </a>
                
                <p style="color: var(--text-tertiary); font-size: 12px; margin: 0; line-height: 1.4;">
                    © 2025 KHAI, Беларусь.<br>
                    Все права защищены!
                </p>
            </div>
        </div>
    </div>

    <!-- Edit Chat Modal -->
    <div class="modal-overlay" id="editChatModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Редактировать название чата</h3>
                <button class="modal-close" id="editChatModalClose">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-input-wrapper">
                    <input type="text" id="editChatNameInput" placeholder="Введите название чата..." maxlength="16" class="modal-input">
                    <button class="modal-clear-input" id="modalClearInput" style="display: none;">
                        <i class="ti ti-x"></i>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="editChatModalCancel">Отмена</button>
                <button class="modal-btn primary" id="editChatModalSave">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Model Selection Modal -->
    <div class="modal-overlay" id="modelModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Выберите модель ИИ</h3>
                <button class="modal-close" id="modelModalClose">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="model-list" id="modelList"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="modelModalCancel">Отмена</button>
                <button class="modal-btn primary" id="modelModalConfirm">Выбрать</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js" defer></script>
    <script src="./script.js" defer></script>

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker зарегистрирован: ', registration);
                    })
                    .catch(error => {
                        console.log('Ошибка регистрации ServiceWorker: ', error);
                    });
            });
        }
        
        // LCP Optimization
        document.addEventListener('DOMContentLoaded', function() {
            // Preload LCP image
            const lcpImage = new Image();
            lcpImage.src = './logo.png';
            lcpImage.fetchPriority = 'high';
            
            // LCP fallback
            setTimeout(() => {
                if (!lcpImage.complete) {
                    const logos = document.querySelectorAll('.logo img, .preloader-logo');
                    logos.forEach(img => {
                        img.style.visibility = 'hidden';
                    });
                }
            }, 2500);
            
            // CLS prevention
            const reservedHeights = {
                messages: '200px',
                input: '48px',
                header: '50px',
                footer: '40px'
            };
            
            Object.keys(reservedHeights).forEach(area => {
                const element = document.getElementById(area + 'Container') || 
                               document.querySelector('.' + area);
                if (element) {
                    element.style.minHeight = reservedHeights[area];
                }
            });
        });
    </script>
</body>
</html>
