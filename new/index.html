<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>KHAI - AI Чат-помощник</title>
    <meta name="description" content="KHAI - Полностью бесплатный ИИ-помощник с генерацией изображений и голоса">
    <meta name="theme-color" content="#0f0f23">
    
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    
    <!-- Puter AI SDK -->
    <script src="https://js.puter.com/v2/"></script>
    
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* KHAI Brand Colors */
            --khai-primary: #0066ff;
            --khai-secondary: #0099ff;
            --khai-accent: #00ccff;
            --khai-dark: #0a0a1f;
            --khai-darker: #050510;
            
            /* Dark theme colors */
            --bg-primary: var(--khai-darker);
            --bg-secondary: rgba(255, 255, 255, 0.03);
            --bg-tertiary: rgba(255, 255, 255, 0.08);
            --bg-hover: rgba(255, 255, 255, 0.12);
            
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --text-tertiary: #8888aa;
            
            --border-color: rgba(255, 255, 255, 0.15);
            
            --accent-primary: var(--khai-primary);
            --accent-secondary: var(--khai-secondary);
            --accent-primary-alpha: rgba(0, 102, 255, 0.2);
            
            --user-message-bg-start: #667eea;
            --user-message-bg-end: #764ba2;
            --user-message-text: #ffffff;
            
            --ai-message-bg: rgba(255, 255, 255, 0.08);
            --ai-message-text: #e8e8ff;
            --ai-message-border: rgba(255, 255, 255, 0.12);
            
            --error-bg: rgba(255, 107, 107, 0.2);
            --error-text: #ff6b6b;
            --error-border: #ff4444;
            
            --success-bg: rgba(0, 255, 0, 0.2);
            --success-text: #00ff00;
            
            --warning-bg: rgba(255, 193, 7, 0.2);
            --warning-text: #ffc107;
            
            --code-bg: #1a1a2e;
            --code-border: #2d2d4d;
            --code-text: #e2e8f0;
            
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Light theme variables */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: rgba(0, 0, 0, 0.03);
            --bg-tertiary: rgba(0, 0, 0, 0.08);
            --bg-hover: rgba(0, 0, 0, 0.12);
            
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #888888;
            
            --border-color: rgba(0, 0, 0, 0.15);
            
            --ai-message-bg: rgba(0, 0, 0, 0.05);
            --ai-message-text: #333333;
            --ai-message-border: rgba(0, 0, 0, 0.1);
            
            --code-bg: #f8f9fa;
            --code-border: #e9ecef;
            --code-text: #495057;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            touch-action: pan-y;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Header */
        .app-header {
            padding: 12px 20px;
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            gap: 15px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .logo {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            overflow: hidden;
            background: linear-gradient(135deg, var(--khai-primary), var(--khai-accent));
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .brand-name {
            font-weight: 700;
            font-size: 18px;
            background: linear-gradient(135deg, var(--khai-primary), var(--khai-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Header Controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .model-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: var(--radius-md);
            font-size: 11px;
            cursor: pointer;
            transition: var(--transition);
            outline: none;
            min-width: 140px;
            height: 32px;
        }

        .model-select:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
        }

        .model-select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary-alpha);
        }

        .model-select option {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .control-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 10px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 11px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
            height: 32px;
            flex-shrink: 0;
        }

        .control-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Chat area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
        }

        /* Navigation buttons */
        .chat-navigation {
            position: absolute;
            right: 15px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 10;
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
        }

        .chat-navigation.visible {
            opacity: 0.7;
            pointer-events: all;
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-primary);
            transform: scale(1.05);
            opacity: 1;
        }

        .nav-btn.active {
            background: var(--accent-primary-alpha);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .message {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: var(--radius-xl);
            line-height: 1.6;
            animation: fadeIn 0.3s ease;
            position: relative;
            font-size: 14px;
            word-wrap: break-word;
        }

        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--user-message-bg-start), var(--user-message-bg-end));
            color: var(--user-message-text);
            margin-left: auto;
            box-shadow: var(--shadow-md);
        }

        .message-ai {
            align-self: flex-start;
            background: var(--ai-message-bg);
            color: var(--ai-message-text);
            border: 1px solid var(--ai-message-border);
            margin-right: auto;
        }

        .message-error {
            align-self: flex-start;
            background: var(--error-bg);
            color: var(--error-text);
            border: 1px solid var(--error-border);
        }

        /* Markdown Styles */
        .message-content {
            line-height: 1.6;
        }

        .message-content pre {
            background: var(--code-bg);
            border: 1px solid var(--code-border);
            border-radius: var(--radius-md);
            padding: 1em;
            margin: 1em 0;
            overflow-x: auto;
            position: relative;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8em;
            padding-bottom: 0.5em;
            border-bottom: 1px solid var(--code-border);
        }

        .code-language {
            font-size: 0.8em;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .copy-code-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.3em 0.6em;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.7em;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.3em;
        }

        .copy-code-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .copy-code-btn.copied {
            background: var(--success-bg);
            color: var(--success-text);
            border-color: var(--success-text);
        }

        /* Model indicator in messages */
        .model-indicator {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 8px;
            font-style: italic;
            border-top: 1px solid var(--border-color);
            padding-top: 6px;
        }

        /* Message actions */
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            justify-content: flex-start;
            flex-wrap: wrap;
        }

        .action-btn-small {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 11px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }

        .action-btn-small:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Input area */
        .input-section {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            align-items: center;
        }

        .attach-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 18px;
            flex-shrink: 0;
            align-self: center;
            position: relative;
            overflow: hidden;
        }

        .attach-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        #userInput {
            flex: 1;
            padding: 14px 120px 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: var(--transition);
            resize: none;
            min-height: 52px;
            max-height: 120px;
            overflow-y: auto;
            line-height: 1.4;
            font-family: inherit;
            align-self: stretch;
        }

        #userInput:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-primary-alpha);
        }

        .input-controls {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .input-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 16px;
        }

        .input-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 16px;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn.stop-generation {
            background: linear-gradient(135deg, #ff4757, #ff3742) !important;
            color: white !important;
            animation: pulseRed 2s ease-in-out infinite;
        }

        @keyframes pulseRed {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(255, 71, 87, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 71, 87, 0);
            }
        }

        /* Attached files */
        .attached-files {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            flex-wrap: wrap;
        }

        .attached-file {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            border-radius: var(--radius-md);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .remove-file {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .remove-file:hover {
            background: var(--error-bg);
            color: var(--error-text);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            justify-content: center;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            flex-wrap: wrap;
        }

        .action-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 11px;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            height: 32px;
        }

        .action-btn:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        /* Footer */
        .app-footer {
            padding: 12px 20px;
            color: var(--text-secondary);
            font-size: 11px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            flex-shrink: 0;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
            max-width: 900px;
            margin: 0 auto;
        }

        .current-chat-info {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 11px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        .notification.info {
            background: var(--accent-primary-alpha);
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
        }

        .notification.success {
            background: var(--success-bg);
            color: var(--success-text);
            border: 1px solid var(--success-text);
        }

        .notification.warning {
            background: var(--warning-bg);
            color: var(--warning-text);
            border: 1px solid var(--warning-text);
        }

        .notification.error {
            background: var(--error-bg);
            color: var(--error-text);
            border: 1px solid var(--error-border);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Sidebar Menu */
        .sidebar-menu {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100vh;
            height: 100dvh;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            z-index: 1000;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .sidebar-menu.active {
            right: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .sidebar-header h3 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .sidebar-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .sidebar-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 1;
        }

        .sidebar-section h4 {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-btn {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .sidebar-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar-btn.primary {
            background: var(--accent-primary-alpha);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .sidebar-btn.primary:hover {
            background: var(--accent-primary);
            color: white;
        }

        /* Chat list in sidebar */
        .sidebar-section .chat-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .sidebar-section .chat-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-section .chat-item:hover {
            background: var(--bg-hover);
        }

        .sidebar-section .chat-item:last-child {
            border-bottom: none;
        }

        .sidebar-section .chat-item.active {
            background: var(--accent-primary-alpha);
            color: var(--accent-primary);
        }

        .sidebar-section .chat-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .sidebar-section .chat-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .edit-chat-btn, .delete-chat-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }

        .edit-chat-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .delete-chat-btn:hover {
            background: var(--error-bg);
            color: var(--error-text);
        }

        /* Modal for editing chat name */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .modal-header h3 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: var(--transition);
        }

        .modal-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary-alpha);
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .modal-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-btn.primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .modal-btn.primary:hover {
            background: var(--accent-secondary);
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .app-header {
                padding: 10px 15px;
                padding-top: calc(10px + env(safe-area-inset-top, 0px));
            }

            .header-content {
                flex-wrap: wrap;
                gap: 8px;
            }

            .logo {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .brand-name {
                font-size: 16px;
            }

            .header-controls {
                gap: 6px;
            }

            .model-select {
                min-width: 120px;
                font-size: 10px;
                height: 28px;
            }

            .control-btn {
                font-size: 10px;
                height: 28px;
                padding: 4px 8px;
            }

            .messages-container {
                padding: 15px;
                padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
            }

            .message {
                max-width: 90%;
                padding: 12px 16px;
                font-size: 13px;
            }

            .chat-navigation {
                right: 10px;
                bottom: 90px;
            }

            .nav-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .input-section {
                padding: 12px 15px;
                padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            }

            #userInput {
                padding: 12px 100px 12px 12px;
                font-size: 13px;
            }

            .input-btn, .send-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .action-btn {
                font-size: 10px;
                height: 28px;
                padding: 4px 10px;
            }

            .sidebar-menu {
                width: 280px;
            }

            .modal {
                width: 95%;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 95%;
            }

            .header-controls {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }

            .model-select {
                flex: 1;
                max-width: 140px;
            }

            .action-buttons {
                gap: 4px;
            }

            .action-btn {
                font-size: 9px;
                padding: 4px 8px;
                height: 26px;
            }
        }

        /* Print styles */
        @media print {
            .app-header, .input-section, .app-footer, .chat-navigation {
                display: none !important;
            }

            .messages-container {
                overflow: visible !important;
                height: auto !important;
            }

            .message {
                max-width: 100% !important;
                break-inside: avoid;
            }
        }

        /* Voice input active state */
        .voice-input-active {
            background: var(--accent-primary-alpha) !important;
            color: var(--accent-primary) !important;
            border-color: var(--accent-primary) !important;
        }

        /* Image mode active state */
        .image-mode-active {
            background: var(--accent-primary-alpha) !important;
            color: var(--accent-primary) !important;
            border-color: var(--accent-primary) !important;
        }

        /* Voice mode active state */
        .voice-mode-active {
            background: var(--accent-primary-alpha) !important;
            color: var(--accent-primary) !important;
            border-color: var(--accent-primary) !important;
        }

        /* Streaming message styles */
        .streaming-message {
            position: relative;
        }

        .streaming-content {
            position: relative;
        }

        .typing-indicator-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .typing-indicator-inline.fade-out {
            opacity: 0;
            height: 0;
            margin-bottom: 0;
            overflow: hidden;
        }

        .streaming-text {
            min-height: 20px;
        }

        /* Input disabled state */
        .input-disabled {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Audio player styles */
        .audio-player {
            margin-top: 12px;
        }

        .audio-player audio {
            width: 100%;
            max-width: 300px;
            border-radius: var(--radius-md);
        }

        /* Speak button active state */
        .speak-btn.speaking {
            background: var(--accent-primary-alpha) !important;
            color: var(--accent-primary) !important;
            border-color: var(--accent-primary) !important;
        }

        /* Download buttons */
        .download-file-btn {
            font-size: 10px;
            padding: 4px 8px;
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for keyboard navigation */
        button:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #ffffff;
                --text-secondary: #ffffff;
                --bg-tertiary: #000000;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo" id="logoBtn">
                        <span>K</span>
                    </div>
                    <div class="brand-name">KHAI</div>
                </div>
                
                <div class="header-controls">
                    <select id="modelSelect" class="model-select">
                        <option value="gpt-5-nano">GPT-5 Nano</option>
                        <option value="o3-mini">O3 Mini</option>
                        <option value="claude-sonnet">Claude Sonnet</option>
                        <option value="deepseek-chat">DeepSeek Chat</option>
                        <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="grok-beta">xAI Grok</option>
                    </select>
                    
                    <button id="menuToggle" class="control-btn" title="Меню">
                        <i class="ti ti-menu-2"></i>
                        <span>Меню</span>
                    </button>
                    
                    <button id="themeToggle" class="control-btn" title="Сменить тему">
                        <i class="ti ti-sun"></i>
                        <span>Тема</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div id="messagesContainer" class="messages-container"></div>
            
            <!-- Navigation Buttons -->
            <div id="chatNavigation" class="chat-navigation">
                <button id="scrollToLastAI" class="nav-btn" title="К последнему ответу ИИ">
                    <i class="ti ti-arrow-down"></i>
                </button>
                <button id="scrollToBottom" class="nav-btn" title="Вниз">
                    <i class="ti ti-arrow-down"></i>
                </button>
            </div>
        </main>

        <!-- Input Section -->
        <section class="input-section">
            <div class="input-wrapper">
                <button id="attachFileBtn" class="attach-btn" title="Прикрепить файл">
                    <i class="ti ti-plus"></i>
                    <input type="file" id="fileInput" accept="image/*,.txt" multiple style="display: none;">
                </button>
                
                <textarea 
                    id="userInput" 
                    placeholder="Задайте вопрос или опишите изображение..." 
                    rows="1"
                    maxlength="4000"
                ></textarea>
                
                <div class="input-controls">
                    <button id="voiceInputBtn" class="input-btn" title="Голосовой ввод">
                        <i class="ti ti-microphone"></i>
                    </button>
                    <button id="clearInputBtn" class="input-btn" title="Очистить ввод">
                        <i class="ti ti-x"></i>
                    </button>
                    <button id="sendBtn" class="send-btn" title="Отправить сообщение">
                        <i class="ti ti-send"></i>
                    </button>
                </div>
            </div>
            
            <!-- Attached Files -->
            <div id="attachedFiles" class="attached-files"></div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="generateImageBtn" class="action-btn" title="Генерация изображения">
                    <i class="ti ti-photo"></i>
                    <span>Изображение</span>
                </button>
                <button id="generateVoiceBtn" class="action-btn" title="Генерация голоса">
                    <i class="ti ti-microphone"></i>
                    <span>Голос</span>
                </button>
                <button id="clearChatBtn" class="action-btn" title="Очистить чат">
                    <i class="ti ti-trash"></i>
                    <span>Очистить</span>
                </button>
                <button id="helpBtn" class="action-btn" title="Помощь">
                    <i class="ti ti-help"></i>
                    <span>Помощь</span>
                </button>
            </div>
        </section>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                <div class="current-chat-info">
                    <i class="ti ti-message"></i>
                    <span id="currentChatName">Основной чат</span>
                </div>
                <span>•</span>
                <span>KHAI AI Assistant v1.0</span>
                <span>•</span>
                <span>Полностью бесплатно</span>
            </div>
        </footer>
    </div>

    <!-- Sidebar Menu -->
    <div id="sidebarMenu" class="sidebar-menu">
        <div class="sidebar-header">
            <h3>Меню KHAI</h3>
            <button id="sidebarClose" class="sidebar-close">
                <i class="ti ti-x"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <div class="sidebar-section">
                <h4>Чаты</h4>
                <button id="newChatBtn" class="sidebar-btn primary">
                    <i class="ti ti-plus"></i>
                    <span>Новый чат</span>
                </button>
                <div id="chatList" class="chat-list"></div>
            </div>
            
            <div class="sidebar-section">
                <h4>Настройки</h4>
                <button class="sidebar-btn">
                    <i class="ti ti-settings"></i>
                    <span>Настройки приложения</span>
                </button>
                <button class="sidebar-btn">
                    <i class="ti ti-shield"></i>
                    <span>Конфиденциальность</span>
                </button>
            </div>
            
            <div class="sidebar-section">
                <h4>Информация</h4>
                <button class="sidebar-btn">
                    <i class="ti ti-info-circle"></i>
                    <span>О программе</span>
                </button>
                <button class="sidebar-btn">
                    <i class="ti ti-help"></i>
                    <span>Справка</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Edit Chat Modal -->
    <div id="editChatModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Редактировать название чата</h3>
                <button id="editChatModalClose" class="modal-close">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="editChatNameInput" class="modal-input" placeholder="Введите название чата..." maxlength="50">
            </div>
            <div class="modal-footer">
                <button id="editChatModalCancel" class="modal-btn">Отмена</button>
                <button id="editChatModalSave" class="modal-btn primary">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // KHAI AI Assistant Class
        class KHAIAssistant {
            constructor() {
                this.initializeElements();
                this.initializeState();
                this.setupMarked();
                this.init();
            }

            initializeElements() {
                // Основные элементы интерфейса
                this.messagesContainer = document.getElementById('messagesContainer');
                this.userInput = document.getElementById('userInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.clearInputBtn = document.getElementById('clearInputBtn');
                this.clearChatBtn = document.getElementById('clearChatBtn');
                this.helpBtn = document.getElementById('helpBtn');
                this.generateImageBtn = document.getElementById('generateImageBtn');
                this.generateVoiceBtn = document.getElementById('generateVoiceBtn');
                this.themeToggle = document.getElementById('themeToggle');
                this.modelSelect = document.getElementById('modelSelect');
                this.logo = document.getElementById('logoBtn');
                this.attachFileBtn = document.getElementById('attachFileBtn');
                this.voiceInputBtn = document.getElementById('voiceInputBtn');
                this.fileInput = document.getElementById('fileInput');
                this.attachedFiles = document.getElementById('attachedFiles');
                this.currentChatName = document.getElementById('currentChatName');
                this.inputSection = document.getElementById('inputSection');
                
                // Элементы навигации
                this.chatNavigation = document.getElementById('chatNavigation');
                this.scrollToLastAI = document.getElementById('scrollToLastAI');
                this.scrollToBottomBtn = document.getElementById('scrollToBottom');

                // Элементы меню
                this.menuToggle = document.getElementById('menuToggle');
                this.sidebarMenu = document.getElementById('sidebarMenu');
                this.sidebarOverlay = document.getElementById('sidebarOverlay');
                this.sidebarClose = document.getElementById('sidebarClose');
                this.chatList = document.getElementById('chatList');
                this.newChatBtn = document.getElementById('newChatBtn');

                // Элементы модального окна редактирования
                this.editChatModal = document.getElementById('editChatModal');
                this.editChatNameInput = document.getElementById('editChatNameInput');
                this.editChatModalClose = document.getElementById('editChatModalClose');
                this.editChatModalCancel = document.getElementById('editChatModalCancel');
                this.editChatModalSave = document.getElementById('editChatModalSave');
                this.editingChatId = null;
            }

            initializeState() {
                // Состояние приложения
                this.isProcessing = false;
                this.currentTheme = 'dark';
                this.isImageMode = false;
                this.isVoiceMode = false;
                this.attachedImages = [];
                this.isListening = false;
                this.recognition = null;
                this.conversationHistory = [];
                this.currentModel = 'gpt-5-nano';
                this.currentAudio = null;
                this.isSpeaking = false;
                this.currentUtterance = null;
                this.chatSessions = new Map();
                this.currentChatId = 'default';
                this.activeTypingIndicator = null;
                this.activeStreamingMessage = null;
                this.activeTimeouts = new Set();
                this.activeEventListeners = new Map();
                this.autoScrollEnabled = true;
                
                // Новые состояния для управления генерацией
                this.isGenerating = false;
                this.generationAborted = false;
                this.currentStreamController = null;
                this.lastUserMessage = null;
                
                // Состояния для навигации
                this.isAtBottom = true;
                this.isAtTop = false;
                this.lastAIMessageIndex = -1;

                // Конфигурация
                this.placeholderExamples = [
                    "Расскажи о возможностях KHAI AI Assistant...",
                    "Напиши код для сортировки массива на Python...",
                    "Объясни теорию относительности простыми словами...",
                    "Какие есть способы улучшить производительность веб-сайта?",
                    "Создай описание для приложения на основе ИИ..."
                ];

                this.modelConfig = {
                    'gpt-5-nano': { 
                        name: 'GPT-5 Nano', 
                        description: 'Быстрая и эффективная модель для повседневных задач' 
                    },
                    'o3-mini': { 
                        name: 'O3 Mini', 
                        description: 'Продвинутая модель с улучшенными возможностями рассуждения' 
                    },
                    'claude-sonnet': { 
                        name: 'Claude Sonnet', 
                        description: 'Мощная модель от Anthropic для сложных задач и анализа' 
                    },
                    'deepseek-chat': { 
                        name: 'DeepSeek Chat', 
                        description: 'Универсальная модель для общения и решения задач' 
                    },
                    'deepseek-reasoner': { 
                        name: 'DeepSeek Reasoner', 
                        description: 'Специализированная модель для сложных логических рассуждений' 
                    },
                    'gemini-2.0-flash': { 
                        name: 'Gemini 2.0 Flash', 
                        description: 'Новейшая быстрая модель от Google с улучшенными возможностями' 
                    },
                    'gemini-1.5-flash': { 
                        name: 'Gemini 1.5 Flash', 
                        description: 'Быстрая и эффективная модель от Google для различных задач' 
                    },
                    'grok-beta': { 
                        name: 'xAI Grok', 
                        description: 'Модель от xAI с уникальным характером и остроумными ответами' 
                    }
                };
            }

            setupMarked() {
                marked.setOptions({
                    highlight: (code, lang) => {
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (err) {
                                console.warn(`Error highlighting ${lang}:`, err);
                            }
                        }
                        return hljs.highlightAuto(code).value;
                    },
                    langPrefix: 'hljs language-',
                    breaks: true,
                    gfm: true
                });
            }

            init() {
                try {
                    this.bindEvents();
                    this.setupAutoResize();
                    this.setupVoiceRecognition();
                    this.startPlaceholderAnimation();
                    this.loadModelPreference();
                    this.loadThemePreference();
                    this.loadChatSessions();
                    this.setupChatSelector();
                    this.loadCurrentSession();
                    this.setupScrollTracking();
                    
                    this.showNotification('KHAI AI Assistant загружен и готов к работе!', 'success');
                } catch (error) {
                    console.error('Ошибка инициализации:', error);
                    this.showNotification('Ошибка загрузки приложения', 'error');
                }
            }

            bindEvents() {
                // Основные обработчики событий
                const events = [
                    [this.sendBtn, 'click', () => this.handleSendButtonClick()],
                    [this.userInput, 'keydown', (e) => this.handleInputKeydown(e)],
                    [this.userInput, 'input', () => this.handleInputChange()],
                    [this.clearInputBtn, 'click', () => this.clearInput()],
                    [this.clearChatBtn, 'click', () => this.clearChat()],
                    [this.helpBtn, 'click', () => this.showHelp()],
                    [this.generateImageBtn, 'click', (e) => this.handleImageMode(e)],
                    [this.generateVoiceBtn, 'click', () => this.toggleVoiceMode()],
                    [this.themeToggle, 'click', () => this.toggleTheme()],
                    [this.modelSelect, 'change', (e) => this.handleModelChange(e)],
                    [this.logo, 'click', () => this.refreshPage()],
                    [this.attachFileBtn, 'click', () => this.fileInput.click()],
                    [this.fileInput, 'change', (e) => this.handleFileSelect(e)],
                    [this.voiceInputBtn, 'click', () => this.toggleVoiceInput()],
                    [this.menuToggle, 'click', () => this.toggleSidebar()],
                    [this.sidebarClose, 'click', () => this.closeSidebar()],
                    [this.sidebarOverlay, 'click', () => this.closeSidebar()],
                    [this.newChatBtn, 'click', () => this.createNewChat()],
                    [window, 'beforeunload', () => this.handleBeforeUnload()],
                    [this.editChatModalClose, 'click', () => this.closeEditChatModal()],
                    [this.editChatModalCancel, 'click', () => this.closeEditChatModal()],
                    [this.editChatModalSave, 'click', () => this.saveChatName()],
                    [this.editChatNameInput, 'keydown', (e) => {
                        if (e.key === 'Enter') this.saveChatName();
                        if (e.key === 'Escape') this.closeEditChatModal();
                    }],
                    [this.scrollToLastAI, 'click', () => this.scrollToLastAIMessage()],
                    [this.scrollToBottomBtn, 'click', () => this.scrollToBottom(true)],
                    [this.messagesContainer, 'scroll', () => this.handleScroll()]
                ];

                events.forEach(([element, event, handler]) => {
                    this.addEventListener(element, event, handler);
                });
            }

            refreshPage() {
                location.reload();
            }

            setupScrollTracking() {
                this.updateNavigationButtons();
            }

            handleScroll() {
                const container = this.messagesContainer;
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;
                
                this.isAtBottom = scrollHeight - scrollTop - clientHeight < 50;
                this.isAtTop = scrollTop < 50;
                
                this.updateNavigationButtons();
                this.autoScrollEnabled = this.isAtBottom;
            }

            updateNavigationButtons() {
                const aiMessages = this.messagesContainer.querySelectorAll('.message-ai:not(.typing-indicator)');
                const hasAIMessages = aiMessages.length > 0;
                
                this.scrollToLastAI.classList.toggle('active', !this.isAtBottom && hasAIMessages);
                this.scrollToLastAI.disabled = !hasAIMessages;
                
                this.scrollToBottomBtn.classList.toggle('active', !this.isAtBottom);
                this.scrollToBottomBtn.disabled = this.isAtBottom;
                
                if (this.isAtBottom) {
                    this.chatNavigation.classList.remove('visible');
                } else {
                    this.chatNavigation.classList.add('visible');
                }
            }

            scrollToLastAIMessage() {
                const aiMessages = this.messagesContainer.querySelectorAll('.message-ai:not(.typing-indicator)');
                if (aiMessages.length > 0) {
                    const lastAIMessage = aiMessages[aiMessages.length - 1];
                    lastAIMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    this.setTimeout(() => this.updateNavigationButtons(), 300);
                }
            }

            scrollToBottom(force = false) {
                if (force) {
                    this.autoScrollEnabled = true;
                }
                
                if (this.autoScrollEnabled) {
                    this.setTimeout(() => {
                        if (this.messagesContainer) {
                            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                            this.setTimeout(() => this.updateNavigationButtons(), 100);
                        }
                    }, 50);
                }
            }

            handleSendButtonClick() {
                if (this.isGenerating) {
                    this.stopGeneration();
                } else {
                    this.sendMessage();
                }
            }

            handleInputChange() {
                const hasInput = this.userInput.value.trim().length > 0 || this.attachedImages.length > 0;
                
                if (this.isGenerating && hasInput) {
                    this.updateSendButton(false);
                }
            }

            updateSendButton(isGenerating) {
                if (isGenerating) {
                    this.sendBtn.classList.add('stop-generation');
                    this.sendBtn.innerHTML = '<i class="ti ti-player-stop"></i>';
                    this.sendBtn.title = 'Остановить генерацию';
                    
                    this.inputSection.classList.add('input-disabled');
                    this.userInput.disabled = true;
                    this.userInput.placeholder = 'ИИ генерирует ответ... Нажмите остановить для прерывания';
                } else {
                    this.sendBtn.classList.remove('stop-generation');
                    this.sendBtn.innerHTML = '<i class="ti ti-send"></i>';
                    this.sendBtn.title = 'Отправить сообщение';
                    
                    this.inputSection.classList.remove('input-disabled');
                    this.userInput.disabled = false;
                    this.userInput.placeholder = 'Задайте вопрос или опишите изображение...';
                }
            }

            async sendMessage() {
                if (this.isProcessing) {
                    this.showNotification('Подождите завершения предыдущего запроса', 'warning');
                    return;
                }

                const message = this.userInput.value.trim();
                
                if (!message && this.attachedImages.length === 0) {
                    this.showNotification('Введите сообщение или прикрепите файл', 'error');
                    return;
                }

                this.isProcessing = true;
                this.isGenerating = true;
                this.generationAborted = false;
                this.updateSendButton(true);

                try {
                    if (this.isVoiceMode) {
                        await this.generateVoice(message);
                    } else {
                        await this.processUserMessage(message);
                    }
                } catch (error) {
                    console.error('Error in sendMessage:', error);
                    this.handleError('Произошла ошибка при отправке сообщения', error);
                } finally {
                    if (!this.generationAborted) {
                        this.isProcessing = false;
                        this.isGenerating = false;
                        this.updateSendButton(false);
                    }
                }
            }

            stopGeneration() {
                if (this.isGenerating && this.currentStreamController) {
                    this.generationAborted = true;
                    this.isGenerating = false;
                    this.isProcessing = false;
                    
                    if (this.currentStreamController.abort) {
                        this.currentStreamController.abort();
                    }
                    
                    this.removeTypingIndicator();
                    this.updateSendButton(false);
                    
                    if (this.activeStreamingMessage) {
                        const streamingText = this.messagesContainer.querySelector(`#${this.activeStreamingMessage} .streaming-text`);
                        if (streamingText) {
                            this.finalizeStreamingMessage(this.activeStreamingMessage, streamingText.innerHTML);
                        }
                    }
                    
                    this.showNotification('Генерация остановлена', 'info');
                    this.currentStreamController = null;
                }
            }

            async processUserMessage(message) {
                this.lastUserMessage = {
                    text: message,
                    files: [...this.attachedImages]
                };
                
                this.addMessage('user', message, this.attachedImages);
                this.addToConversationHistory('user', message, this.attachedImages);
                
                this.userInput.value = '';
                this.userInput.style.height = 'auto';
                const filesToProcess = [...this.attachedImages];
                this.attachedImages = [];
                this.renderAttachedFiles();
                
                if (this.isImageMode) {
                    await this.generateImage(message);
                } else {
                    await this.getAIResponse(message, filesToProcess);
                }
            }

            async getAIResponse(userMessage, files) {
                this.removeTypingIndicator();
                this.activeTypingIndicator = this.showTypingIndicator();
                
                try {
                    const prompt = await this.buildPrompt(userMessage, files);
                    const response = await this.callAIService(prompt);
                    
                    this.removeTypingIndicator();
                    await this.processAIResponse(response);
                    
                } catch (error) {
                    this.removeTypingIndicator();
                    this.handleError('Ошибка при получении ответа от ИИ', error);
                }
            }

            async buildPrompt(userMessage, files) {
                if (files.length > 0) {
                    const file = files[0];
                    
                    if (file.fileType === 'image') {
                        if (typeof puter?.ai?.img2txt !== 'function') {
                            throw new Error('Функция анализа изображений недоступна');
                        }
                        
                        const extractedText = await puter.ai.img2txt(file.data);
                        
                        if (userMessage.trim()) {
                            return `Пользователь отправил изображение "${file.name}" с сопроводительным сообщением: "${userMessage}"

Извлеченный текст с изображения: "${extractedText}"

Ответь на вопрос/сообщение пользователя "${userMessage}", учитывая содержание изображения. Если на изображении есть дополнительная информация (текст, задачи, диаграммы и т.д.) - используй её для полного ответа. Отвечай одним целостным сообщением на русском языке.`;
                        } else {
                            return `Пользователь отправил изображение "${file.name}".

Извлеченный текст с изображения: "${extractedText}"

Проанализируй это изображение. Опиши что изображено, основное содержание. Если есть текст - объясни его значение. Если это задача - реши её. Отвечай подробно на русском языке.`;
                        }
                    } else if (file.fileType === 'text') {
                        const fileContent = file.data;
                        
                        if (userMessage.trim()) {
                            return `Пользователь отправил текстовый файл "${file.name}" с сопроводительным сообщением: "${userMessage}"

Содержимое файла:
"""
${fileContent}
"""

Ответь на вопрос/сообщение пользователя "${userMessage}", учитывая содержимое прикрепленного файла. Проанализируй текст и дай развернутый ответ на основе предоставленной информации. Отвечай на русском языке.`;
                        } else {
                            return `Пользователь отправил текстовый файл "${file.name}".

Содержимое файла:
"""
${fileContent}
"""

Проанализируй содержимое этого файла. Суммируй основную информацию, выдели ключевые моменты, предложи выводы или рекомендации на основе представленного текста. Отвечай подробно на русском языке.`;
                        }
                    }
                } else {
                    return this.buildContextPrompt(userMessage);
                }
            }

            async callAIService(prompt) {
                if (typeof puter?.ai?.chat !== 'function') {
                    throw new Error('Функция чата недоступна');
                }
                
                const modelOptions = {
                    'gpt-5-nano': { model: 'gpt-5-nano' },
                    'o3-mini': { model: 'o3-mini' },
                    'claude-sonnet': { model: 'claude-sonnet' },
                    'deepseek-chat': { model: 'deepseek-chat' },
                    'deepseek-reasoner': { model: 'deepseek-reasoner' },
                    'gemini-2.0-flash': { model: 'gemini-2.0-flash' },
                    'gemini-1.5-flash': { model: 'gemini-1.5-flash' },
                    'grok-beta': { model: 'grok-beta' }
                };
                
                const options = {
                    ...modelOptions[this.currentModel],
                    systemPrompt: "Ты полезный AI-ассистент KHAI. Отвечай на русском языке понятно и подробно. Поддерживай естественный диалог и учитывай контекст предыдущих сообщений.",
                    stream: true
                };
                
                return await puter.ai.chat(prompt, options);
            }

            async processAIResponse(response) {
                this.activeStreamingMessage = this.createStreamingMessage();
                this.currentStreamController = response;
                
                let fullResponse = '';
                try {
                    for await (const part of response) {
                        if (this.generationAborted) break;
                        
                        if (part?.text) {
                            fullResponse += part.text;
                            this.updateStreamingMessage(this.activeStreamingMessage, fullResponse);
                            await this.delay(10);
                        }
                    }
                    
                    if (!this.generationAborted) {
                        this.finalizeStreamingMessage(this.activeStreamingMessage, fullResponse);
                        this.addToConversationHistory('assistant', fullResponse);
                        this.saveCurrentSession();
                        this.isGenerating = false;
                        this.isProcessing = false;
                        this.updateSendButton(false);
                    }
                } catch (error) {
                    if (!this.generationAborted) {
                        console.error('Error processing AI response:', error);
                        this.handleError('Ошибка при обработке ответа ИИ', error);
                        this.isGenerating = false;
                        this.isProcessing = false;
                        this.updateSendButton(false);
                    }
                } finally {
                    this.activeStreamingMessage = null;
                    this.currentStreamController = null;
                }
            }

            delay(ms) {
                return new Promise(resolve => this.setTimeout(resolve, ms));
            }

            createStreamingMessage() {
                const messageElement = document.createElement('div');
                messageElement.className = 'message message-ai streaming-message';
                messageElement.id = 'streaming-' + Date.now();
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content streaming-content';
                
                messageContent.innerHTML = `
                    <div class="typing-indicator-inline">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                        <span>ИИ печатает...</span>
                    </div>
                    <div class="streaming-text"></div>
                `;
                
                messageElement.appendChild(messageContent);
                this.messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
                
                return messageElement.id;
            }

            updateStreamingMessage(messageId, content) {
                const messageElement = document.getElementById(messageId);
                if (!messageElement) return;
                
                const streamingText = messageElement.querySelector('.streaming-text');
                const typingIndicator = messageElement.querySelector('.typing-indicator-inline');
                
                if (content.length > 100 && typingIndicator && !typingIndicator.classList.contains('fade-out')) {
                    typingIndicator.classList.add('fade-out');
                    this.setTimeout(() => {
                        if (typingIndicator.parentNode) {
                            typingIndicator.style.display = 'none';
                        }
                    }, 300);
                }
                
                const processedContent = this.processCodeBlocks(content);
                streamingText.innerHTML = processedContent;
                
                this.attachCopyButtons(streamingText);
                
                if (this.autoScrollEnabled) {
                    this.scrollToBottom();
                }
            }

            finalizeStreamingMessage(messageId, fullContent) {
                const messageElement = document.getElementById(messageId);
                if (!messageElement) return;
                
                messageElement.classList.remove('streaming-message');
                const messageContent = messageElement.querySelector('.message-content');
                messageContent.classList.remove('streaming-content');
                
                const typingIndicator = messageContent.querySelector('.typing-indicator-inline');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                const processedContent = this.processCodeBlocks(fullContent);
                messageContent.innerHTML = processedContent;
                
                const modelIndicator = document.createElement('div');
                modelIndicator.className = 'model-indicator';
                modelIndicator.textContent = `Модель: ${this.getModelDisplayName(this.currentModel)} • ${this.getModelDescription(this.currentModel)}`;
                messageContent.appendChild(modelIndicator);
                
                this.attachMessageHandlers(messageElement);
                this.addDownloadButtons(messageElement, fullContent);
                
                this.scrollToBottom();
            }

            addDownloadButtons(messageElement, content) {
                const messageActions = messageElement.querySelector('.message-actions');
                if (!messageActions) return;

                const hasCode = content.includes('```') || 
                               /(файл|код|скачать|сохранить|download|file)/i.test(content);
                
                if (hasCode) {
                    const fileTypes = [
                        { name: 'Текст', ext: 'txt', icon: 'ti-file-text' },
                        { name: 'Python', ext: 'py', icon: 'ti-brand-python' },
                        { name: 'JavaScript', ext: 'js', icon: 'ti-brand-javascript' },
                        { name: 'HTML', ext: 'html', icon: 'ti-brand-html5' },
                        { name: 'CSS', ext: 'css', icon: 'ti-brand-css3' }
                    ];

                    fileTypes.forEach(fileType => {
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'action-btn-small download-file-btn';
                        downloadBtn.innerHTML = `<i class="ti ${fileType.icon}"></i> ${fileType.name}`;
                        downloadBtn.onclick = () => this.downloadFile(content, fileType.ext);
                        messageActions.appendChild(downloadBtn);
                    });
                }
            }

            downloadFile(content, fileExtension) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const fileName = `khai_assistant_${timestamp}.${fileExtension}`;

                if (typeof puter?.fs?.write === 'function') {
                    puter.fs.write(fileName, plainText)
                        .then(() => {
                            this.showNotification(`Файл "${fileName}" успешно сохранен!`, 'success');
                        })
                        .catch(error => {
                            console.error('Error saving file with puter:', error);
                            this.downloadViaBrowser(plainText, fileName);
                        });
                } else {
                    this.downloadViaBrowser(plainText, fileName);
                }
            }

            downloadViaBrowser(content, fileName) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                this.showNotification(`Файл "${fileName}" скачан`, 'success');
            }

            attachMessageHandlers(messageElement) {
                this.attachCopyButtons(messageElement);
                if (messageElement.classList.contains('message-ai')) {
                    this.attachSpeakButton(messageElement);
                    const messageContent = messageElement.querySelector('.message-content');
                    if (messageContent) {
                        const content = messageContent.textContent || '';
                        this.addDownloadButtons(messageElement, content);
                    }
                }
            }

            attachSpeakButton(messageElement) {
                const messageContent = messageElement.querySelector('.message-content');
                const plainText = this.extractPlainText(messageContent.textContent || '');
                
                if (plainText.trim().length < 10) return;
                
                let actionsContainer = messageElement.querySelector('.message-actions');
                if (!actionsContainer) {
                    actionsContainer = document.createElement('div');
                    actionsContainer.className = 'message-actions';
                    messageElement.appendChild(actionsContainer);
                }
                
                const existingSpeakBtn = actionsContainer.querySelector('.speak-btn');
                if (existingSpeakBtn) {
                    existingSpeakBtn.remove();
                }
                
                const speakButton = document.createElement('button');
                speakButton.className = 'action-btn-small speak-btn';
                speakButton.innerHTML = '<i class="ti ti-speakerphone"></i> Озвучить ответ';
                speakButton.setAttribute('data-text', plainText);
                
                this.addEventListener(speakButton, 'click', (e) => {
                    e.stopPropagation();
                    const text = e.currentTarget.getAttribute('data-text');
                    this.toggleTextToSpeech(text, speakButton);
                });
                
                actionsContainer.appendChild(speakButton);
            }

            extractPlainText(htmlText) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlText;
                return tempDiv.textContent || tempDiv.innerText || '';
            }

            toggleTextToSpeech(text, button) {
                if (this.isSpeaking) {
                    this.stopSpeech();
                    button.classList.remove('speaking');
                    button.innerHTML = '<i class="ti ti-speakerphone"></i> Озвучить ответ';
                } else {
                    this.speakText(text, button);
                }
            }

            speakText(text, button) {
                if (!('speechSynthesis' in window)) {
                    this.showNotification('Озвучивание текста не поддерживается в вашем браузере', 'warning');
                    return;
                }

                try {
                    this.stopSpeech();

                    this.currentUtterance = new SpeechSynthesisUtterance(text);
                    this.currentUtterance.lang = 'ru-RU';
                    this.currentUtterance.rate = 0.85;
                    this.currentUtterance.pitch = 1.0;
                    this.currentUtterance.volume = 1.0;

                    const voices = speechSynthesis.getVoices();
                    const russianVoice = voices.find(voice => 
                        voice.lang.includes('ru') || voice.lang.includes('RU')
                    );
                    
                    if (russianVoice) {
                        this.currentUtterance.voice = russianVoice;
                        this.currentUtterance.rate = 0.8;
                    }

                    button.classList.add('speaking');
                    button.innerHTML = '<i class="ti ti-player-pause"></i> Остановить';
                    this.isSpeaking = true;

                    this.currentUtterance.onend = () => {
                        this.isSpeaking = false;
                        button.classList.remove('speaking');
                        button.innerHTML = '<i class="ti ti-speakerphone"></i> Озвучить ответ';
                    };

                    this.currentUtterance.onerror = (error) => {
                        console.error('Speech synthesis error:', error);
                        this.isSpeaking = false;
                        button.classList.remove('speaking');
                        button.innerHTML = '<i class="ti ti-speakerphone"></i> Озвучить ответ';
                        this.showNotification('Ошибка при озвучивании текста', 'error');
                    };

                    speechSynthesis.speak(this.currentUtterance);
                    this.showNotification('Озвучивание текста...', 'info');

                } catch (error) {
                    console.error('Error speaking text:', error);
                    this.showNotification('Ошибка при озвучивании текста', 'error');
                }
            }

            stopSpeech() {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
                this.isSpeaking = false;
                this.currentUtterance = null;
            }

            async generateVoice(text) {
                if (typeof puter?.ai?.txt2speech !== 'function') {
                    throw new Error('Функция генерации голоса недоступна');
                }
                
                if (!text.trim()) {
                    this.showNotification('Введите текст для генерации голоса', 'error');
                    return;
                }

                try {
                    this.addMessage('user', `🔊 **Генерация голоса:** "${text}"`);
                    
                    this.userInput.value = '';
                    this.userInput.style.height = 'auto';
                    
                    this.showNotification('Генерация голоса...', 'info');
                    
                    const audio = await puter.ai.txt2speech(text);
                    this.addVoiceMessage(text, audio);
                    
                    this.addToConversationHistory('user', `Сгенерирован голос для текста: ${text}`);
                    this.saveCurrentSession();
                    
                } catch (error) {
                    this.handleError('Ошибка при генерации голоса', error);
                }
            }

            addVoiceMessage(text, audio) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message message-ai';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                messageContent.innerHTML = `
                    🔊 **Сгенерированный голос для текста:** "${this.escapeHtml(text)}"
                    <div class="audio-player" style="margin-top: 12px;">
                        <audio controls style="width: 100%; max-width: 300px;">
                            <source src="${audio.src}" type="audio/mpeg">
                            Ваш браузер не поддерживает аудио элементы.
                        </audio>
                    </div>
                `;
                
                messageElement.appendChild(messageContent);
                this.messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
                
                const audioElement = messageContent.querySelector('audio');
                audioElement.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                });
            }

            buildContextPrompt(currentMessage) {
                const recentHistory = this.conversationHistory.slice(-6);
                
                if (recentHistory.length === 0) {
                    return currentMessage;
                }

                let context = "Контекст предыдущего разговора:\n";
                
                recentHistory.forEach(msg => {
                    const role = msg.role === 'user' ? 'Пользователь' : 'Ассистент';
                    const content = msg.content.length > 500 ? msg.content.substring(0, 500) + '...' : msg.content;
                    context += `${role}: ${content}\n`;
                });

                context += `\nТекущий вопрос пользователя: ${currentMessage}\n\nОтветь, учитывая контекст выше:`;

                return context;
            }

            addToConversationHistory(role, content, images = []) {
                let messageContent = content;
                
                if (images && images.length > 0) {
                    const imageNames = images.map(img => img.name).join(', ');
                    messageContent += ` [Прикреплено изображение: ${imageNames}]`;
                }
                
                this.conversationHistory.push({
                    role: role,
                    content: messageContent,
                    timestamp: Date.now()
                });

                if (this.conversationHistory.length > 30) {
                    this.conversationHistory = this.conversationHistory.slice(-25);
                }
            }

            async generateImage(prompt) {
                try {
                    if (typeof puter?.ai?.imagine !== 'function') {
                        throw new Error('Функция генерации изображений недоступна');
                    }
                    
                    this.addMessage('ai', `🖼️ **Генерация изображения по запросу:** "${prompt}"\n\n*Идет процесс создания изображения...*`);
                    
                    const imageResult = await puter.ai.imagine(prompt, {
                        model: "dall-e-3",
                        size: "1024x1024"
                    });
                    
                    const messages = this.messagesContainer.querySelectorAll('.message-ai');
                    const lastMessage = messages[messages.length - 1];
                    if (lastMessage) {
                        lastMessage.querySelector('.message-content').innerHTML = 
                            `🖼️ **Сгенерированное изображение по запросу:** "${this.escapeHtml(prompt)}"\n\n` +
                            `<img src="${imageResult.url}" alt="Сгенерированное изображение" style="max-width: 100%; border-radius: 8px;">`;
                    }
                    
                    this.addToConversationHistory('assistant', `Сгенерировано изображение по запросу: ${prompt}`);
                    this.saveCurrentSession();
                    
                } catch (error) {
                    this.handleError('Ошибка при генерации изображения', error);
                }
            }

            toggleImageMode() {
                this.isImageMode = !this.isImageMode;
                const placeholder = this.isImageMode 
                    ? "Опишите изображение для генерации..." 
                    : "Задайте вопрос или опишите изображение...";
                
                this.userInput.placeholder = placeholder;
                this.generateImageBtn.classList.toggle('image-mode-active', this.isImageMode);
                
                const icon = this.generateImageBtn.querySelector('i');
                icon.className = this.isImageMode ? 'ti ti-photo-off' : 'ti ti-photo';
                
                this.showNotification(
                    this.isImageMode ? 'Режим генерации изображений включен' : 'Режим генерации изображений выключен',
                    'info'
                );
            }

            addMessage(role, content, images = []) {
                const messageElement = document.createElement('div');
                messageElement.className = `message message-${role}`;
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                try {
                    const processedContent = this.processCodeBlocks(content);
                    messageContent.innerHTML = processedContent;
                } catch {
                    messageContent.textContent = content;
                }
                
                if (role === 'ai') {
                    const modelIndicator = document.createElement('div');
                    modelIndicator.className = 'model-indicator';
                    modelIndicator.textContent = `Модель: ${this.getModelDisplayName(this.currentModel)} • ${this.getModelDescription(this.currentModel)}`;
                    messageContent.appendChild(modelIndicator);
                }
                
                if (images && images.length > 0) {
                    images.forEach(image => {
                        if (image.fileType === 'image') {
                            const imageContainer = document.createElement('div');
                            imageContainer.className = 'message-image';
                            
                            const img = document.createElement('img');
                            img.src = image.data;
                            img.alt = image.name;
                            img.style.maxWidth = '200px';
                            img.style.borderRadius = '8px';
                            img.style.marginTop = '8px';
                            
                            imageContainer.appendChild(img);
                            messageContent.appendChild(imageContainer);
                        } else if (image.fileType === 'text') {
                            const fileContainer = document.createElement('div');
                            fileContainer.className = 'attached-file';
                            fileContainer.style.marginTop = '8px';
                            fileContainer.innerHTML = `
                                <i class="ti ti-file-text"></i>
                                <span>${this.escapeHtml(image.name)} (Текстовый файл)</span>
                            `;
                            messageContent.appendChild(fileContainer);
                        }
                    });
                }
                
                messageElement.appendChild(messageContent);
                this.messagesContainer.appendChild(messageElement);
                
                this.attachMessageHandlers(messageElement);
                this.scrollToBottom();
                
                return messageElement;
            }

            processCodeBlocks(content) {
                let html = marked.parse(content);
                
                html = html.replace(/<pre><code class="([^"]*)">/g, (match, lang) => {
                    const language = lang || 'text';
                    return `
                        <div class="code-header">
                            <span class="code-language">${language}</span>
                            <button class="copy-code-btn" data-language="${language}">
                                <i class="ti ti-copy"></i>
                                Копировать
                            </button>
                        </div>
                        <pre><code class="${lang}">`;
                });
                
                return html;
            }

            attachCopyButtons(container) {
                const copyButtons = container.querySelectorAll('.copy-code-btn');
                copyButtons.forEach(btn => {
                    this.addEventListener(btn, 'click', async (e) => {
                        const codeBlock = e.target.closest('.code-header')?.nextElementSibling;
                        if (codeBlock) {
                            const code = codeBlock.textContent;
                            try {
                                await navigator.clipboard.writeText(code);
                                
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<i class="ti ti-check"></i> Скопировано!';
                                btn.classList.add('copied');
                                
                                this.setTimeout(() => {
                                    btn.innerHTML = originalText;
                                    btn.classList.remove('copied');
                                }, 2000);
                                
                                this.showNotification('Код скопирован в буфер обмена', 'success');
                            } catch (err) {
                                console.error('Failed to copy code:', err);
                                this.showNotification('Не удалось скопировать код', 'error');
                            }
                        }
                    });
                });
            }

            showTypingIndicator() {
                this.removeTypingIndicator();
                
                const typingElement = document.createElement('div');
                typingElement.className = 'message message-ai typing-indicator';
                typingElement.id = 'typing-' + Date.now();
                
                typingElement.innerHTML = `
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span>ИИ печатает...</span>
                `;
                
                this.messagesContainer.appendChild(typingElement);
                this.scrollToBottom();
                
                return typingElement.id;
            }

            removeTypingIndicator(typingId = null) {
                if (typingId) {
                    const element = document.getElementById(typingId);
                    if (element) element.remove();
                } else {
                    const typingElements = this.messagesContainer.querySelectorAll('.typing-indicator');
                    typingElements.forEach(el => el.remove());
                    this.activeTypingIndicator = null;
                }
            }

            clearInput() {
                this.userInput.value = '';
                this.userInput.style.height = 'auto';
                this.attachedImages = [];
                this.renderAttachedFiles();
                this.userInput.focus();
                this.showNotification('Ввод очищен', 'success');
                this.handleInputChange();
            }

            clearChat() {
                if (this.messagesContainer.children.length === 0) {
                    return;
                }

                if (confirm('Вы уверены, что хотите очистить всю историю чата?')) {
                    this.messagesContainer.innerHTML = '';
                    this.conversationHistory = [];
                    this.saveCurrentSession();
                    this.showNotification('Чат очищен', 'success');
                }
            }

            showWelcomeMessage() {
                if (this.conversationHistory.length > 0) {
                    return;
                }
                
                const currentModelName = this.getModelDisplayName(this.currentModel);
                const currentModelDesc = this.getModelDescription(this.currentModel);
                
                const welcomeMessage = `# 👋 Добро пожаловать в KHAI AI Assistant!

Я ваш бесплатный ИИ-помощник с использованием передовых моделей AI. 

## 🎯 Основные возможности:
• **Умные ответы на вопросы** - используя различные модели ИИ
• **Анализ изображений** - извлечение текста и решение задач по фото
• **Анализ текстовых файлов** - чтение и анализ содержимого файлов
• **Голосовой ввод** - говорите вместо того, чтобы печатать
• **Генерация голоса** - преобразование текста в естественную речь
• **Озвучивание ответов** - слушайте ответы ИИ в аудиоформате
• **Контекстный диалог** - помню историю нашего разговора
• **Подсветка синтаксиса** - красивое отображение кода
• **Копирование кода** - удобное копирование фрагментов кода
• **Стриминг ответов** - ответы появляются постепенно
• **Мульти-чаты** - создавайте отдельные чаты для разных тем
• **Редактирование названий чатов** - нажмите на иконку карандаша

**Текущая модель: ${currentModelName}** - ${currentModelDesc}

**Начните общение, отправив сообщение, изображение или текстовый файл!**`;

                this.addMessage('ai', welcomeMessage);
                this.addToConversationHistory('assistant', welcomeMessage);
            }

            showHelp() {
                const currentModelName = this.getModelDisplayName(this.currentModel);
                
                const helpMessage = `# 🆘 Помощь по KHAI AI Assistant

## 🤖 Текущая модель: ${currentModelName}
Вы можете переключать модели в верхнем правом углу.

## 💬 Система чатов:
• **Создание нового чата** - нажмите "Новый чат" в меню
• **Редактирование названия** - нажмите на иконку карандаша рядом с чатом
• **Переключение между чатами** - выберите чат из списка в меню
• **Удаление чатов** - нажмите ❌ рядом с названием чата (кроме основного)

## 📁 Работа с файлами:
• **Изображения** - прикрепите для анализа текста и содержимого
• **Текстовые файлы** - прикрепите для анализа содержимого (.txt)
• **Максимум файлов** - можно прикрепить до 3 файлов за раз

## 🔊 Аудио функции:
• **Генерация голоса** - создает аудио из текста с помощью ИИ
• **Озвучить ответ** - воспроизводит ответ ИИ
• **Остановить озвучку** - нажмите кнопку повторно для остановки

## 🖼️ Работа с изображениями:
1. **Нажмите кнопку ➕** чтобы прикрепить изображение
2. **Напишите вопрос** (опционально) - что вы хотите узнать о изображении
3. **Нажмите Отправить** - ИИ проанализирует изображение и ответит

## 📄 Работа с текстовых файлов:
1. **Нажмите кнопку ➕** чтобы прикрепить текстовый файл
2. **Напишите вопрос** (опционально) - что вы хотите узнать о содержимом
3. **Нажмите Отправить** - ИИ проанализирует файл и ответит

**Попробуйте отправить изображение или текстовый файл с вопросом!**`;

                this.addMessage('ai', helpMessage);
                this.addToConversationHistory('assistant', helpMessage);
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', this.currentTheme);
                
                try {
                    localStorage.setItem('khai-assistant-theme', this.currentTheme);
                } catch (error) {
                    console.error('Error saving theme preference:', error);
                }
                
                this.showNotification(
                    this.currentTheme === 'dark' ? 'Темная тема включена' : 'Светлая тема включена',
                    'info'
                );
            }

            loadThemePreference() {
                try {
                    const savedTheme = localStorage.getItem('khai-assistant-theme');
                    if (savedTheme === 'light' || savedTheme === 'dark') {
                        this.currentTheme = savedTheme;
                        document.body.setAttribute('data-theme', savedTheme);
                    }
                } catch (error) {
                    console.error('Error loading theme preference:', error);
                }
            }

            showNotification(message, type = 'info') {
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(notification => notification.remove());
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                this.setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 4000);
            }

            handleError(userMessage, error) {
                console.error(userMessage, error);
                this.addMessage('error', `${userMessage}: ${error.message}`);
                this.showNotification(userMessage, 'error');
            }

            // Система чатов
            setupChatSelector() {
                if (!this.chatSessions.has('default')) {
                    this.createDefaultChat();
                }
                this.updateChatDropdown();
            }

            createDefaultChat() {
                const defaultSession = {
                    id: 'default',
                    name: 'Основной чат',
                    messages: [],
                    conversationHistory: [],
                    createdAt: Date.now(),
                    lastActivity: Date.now()
                };
                this.chatSessions.set('default', defaultSession);
                this.currentChatId = 'default';
                this.saveChatSessions();
            }

            toggleSidebar() {
                this.sidebarMenu.classList.toggle('active');
                this.sidebarOverlay.classList.toggle('active');
                if (this.sidebarMenu.classList.contains('active')) {
                    this.updateChatDropdown();
                }
            }

            closeSidebar() {
                this.sidebarMenu.classList.remove('active');
                this.sidebarOverlay.classList.remove('active');
            }

            updateChatDropdown() {
                if (!this.chatList) return;
                
                this.chatList.innerHTML = '';

                const sessionsArray = Array.from(this.chatSessions.entries())
                    .sort(([,a], [,b]) => b.lastActivity - a.lastActivity);

                if (sessionsArray.length === 0) {
                    this.createDefaultChat();
                    this.updateChatDropdown();
                    return;
                }

                sessionsArray.forEach(([id, session]) => {
                    const chatItem = this.createChatItem(id, session);
                    this.chatList.appendChild(chatItem);
                });
            }

            createChatItem(id, session) {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${id === this.currentChatId ? 'active' : ''}`;
                chatItem.setAttribute('data-chat-id', id);
                
                chatItem.innerHTML = `
                    <div class="chat-info">
                        <i class="ti ti-message"></i>
                        <span class="chat-name">${this.escapeHtml(session.name)}</span>
                    </div>
                    <div class="chat-actions">
                        <button class="edit-chat-btn" title="Редактировать название чата">
                            <i class="ti ti-pencil"></i>
                        </button>
                        ${id !== 'default' ? '<button class="delete-chat-btn" title="Удалить чат"><i class="ti ti-x"></i></button>' : ''}
                    </div>
                `;

                this.addEventListener(chatItem, 'click', (e) => {
                    if (!e.target.closest('.edit-chat-btn') && !e.target.closest('.delete-chat-btn')) {
                        this.switchChat(id);
                        this.closeSidebar();
                    }
                });

                const editBtn = chatItem.querySelector('.edit-chat-btn');
                if (editBtn) {
                    this.addEventListener(editBtn, 'click', (e) => {
                        e.stopPropagation();
                        this.openEditChatModal(id, session.name);
                    });
                }

                const deleteBtn = chatItem.querySelector('.delete-chat-btn');
                if (deleteBtn) {
                    this.addEventListener(deleteBtn, 'click', (e) => {
                        e.stopPropagation();
                        this.deleteChat(id);
                    });
                }

                return chatItem;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            createNewChat() {
                const chatNumber = Array.from(this.chatSessions.values()).filter(session => 
                    session.name.startsWith('Чат ')
                ).length + 1;
                
                const chatName = `Чат ${chatNumber}`;
                const chatId = this.createChatSession(chatName);
                this.switchChat(chatId);
                this.closeSidebar();
                this.showNotification(`Создан новый чат: ${chatName}`, 'success');
            }

            createChatSession(name = 'Новый чат') {
                const chatId = 'chat-' + Date.now();
                const session = {
                    id: chatId,
                    name: name,
                    messages: [],
                    conversationHistory: [],
                    createdAt: Date.now(),
                    lastActivity: Date.now()
                };
                
                this.chatSessions.set(chatId, session);
                this.saveChatSessions();
                this.updateChatDropdown();
                
                return chatId;
            }

            switchChat(chatId) {
                if (!this.chatSessions.has(chatId) || chatId === this.currentChatId) {
                    return;
                }

                try {
                    this.saveCurrentSession();
                    
                    this.currentChatId = chatId;
                    const session = this.chatSessions.get(chatId);
                    
                    session.lastActivity = Date.now();
                    this.chatSessions.set(chatId, session);
                    
                    this.currentChatName.textContent = session.name;
                    
                    this.loadSession(session);
                    this.showNotification(`Переключен на чат: ${session.name}`, 'info');
                    
                    this.saveChatSessions();
                } catch (error) {
                    console.error('Error switching chat:', error);
                    this.showNotification('Ошибка при переключении чата', 'error');
                }
            }

            deleteChat(chatId) {
                if (chatId === 'default') {
                    this.showNotification('Основной чат нельзя удалить', 'warning');
                    return;
                }

                if (this.chatSessions.size <= 1) {
                    this.showNotification('Нельзя удалить последний чат', 'warning');
                    return;
                }

                const session = this.chatSessions.get(chatId);
                if (!session) return;

                if (confirm(`Удалить чат "${session.name}"?`)) {
                    this.chatSessions.delete(chatId);
                    
                    if (this.currentChatId === chatId) {
                        this.switchChat('default');
                    }
                    
                    this.saveChatSessions();
                    this.updateChatDropdown();
                    this.showNotification('Чат удален', 'success');
                }
            }

            openEditChatModal(chatId, currentName) {
                this.editingChatId = chatId;
                this.editChatNameInput.value = currentName;
                this.editChatModal.classList.add('active');
                
                this.setTimeout(() => {
                    this.editChatNameInput.focus();
                    this.editChatNameInput.select();
                }, 100);
            }

            closeEditChatModal() {
                this.editingChatId = null;
                this.editChatNameInput.value = '';
                this.editChatModal.classList.remove('active');
            }

            saveChatName() {
                if (!this.editingChatId) return;
                
                const newName = this.editChatNameInput.value.trim();
                if (!newName) {
                    this.showNotification('Название чата не может быть пустым', 'error');
                    return;
                }

                const session = this.chatSessions.get(this.editingChatId);
                if (session) {
                    session.name = newName;
                    this.chatSessions.set(this.editingChatId, session);
                    this.saveChatSessions();
                    this.updateChatDropdown();
                    
                    if (this.currentChatId === this.editingChatId) {
                        this.currentChatName.textContent = newName;
                    }
                    
                    this.showNotification('Название чата изменено', 'success');
                }
                
                this.closeEditChatModal();
            }

            saveCurrentSession() {
                try {
                    const messages = [];
                    this.messagesContainer.querySelectorAll('.message').forEach(message => {
                        if (message.classList.contains('typing-indicator') || 
                            message.classList.contains('streaming-message')) return;
                        
                        const role = message.classList.contains('message-user') ? 'user' : 
                                   message.classList.contains('message-error') ? 'error' : 'ai';
                        
                        const content = message.querySelector('.message-content')?.innerHTML || '';
                        if (content) {
                            messages.push({ role, content });
                        }
                    });
                    
                    const session = this.chatSessions.get(this.currentChatId);
                    if (session) {
                        session.messages = messages;
                        session.conversationHistory = [...this.conversationHistory];
                        session.lastActivity = Date.now();
                        this.chatSessions.set(this.currentChatId, session);
                    }
                } catch (error) {
                    console.error('Error saving current session:', error);
                }
            }

            loadCurrentSession() {
                const session = this.chatSessions.get(this.currentChatId);
                if (session) {
                    this.loadSession(session);
                } else {
                    this.showWelcomeMessage();
                }
            }

            loadSession(session) {
                this.messagesContainer.innerHTML = '';
                this.conversationHistory = session.conversationHistory || [];
                
                if (session.messages && session.messages.length > 0) {
                    session.messages.forEach(msg => {
                        this.renderMessage(msg.role, msg.content);
                    });
                } else {
                    this.showWelcomeMessage();
                }
                
                this.scrollToBottom();
            }

            renderMessage(role, content) {
                const messageElement = document.createElement('div');
                messageElement.className = `message message-${role}`;
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.innerHTML = content;
                
                messageElement.appendChild(messageContent);
                this.messagesContainer.appendChild(messageElement);
                
                this.attachMessageHandlers(messageElement);
            }

            // Сохранение и загрузка
            saveModelPreference() {
                try {
                    localStorage.setItem('khai-assistant-model', this.currentModel);
                } catch (error) {
                    console.error('Error saving model preference:', error);
                }
            }

            loadModelPreference() {
                try {
                    const savedModel = localStorage.getItem('khai-assistant-model');
                    if (savedModel && this.modelConfig[savedModel]) {
                        this.currentModel = savedModel;
                        this.modelSelect.value = savedModel;
                    }
                } catch (error) {
                    console.error('Error loading model preference:', error);
                }
            }

            saveChatSessions() {
                try {
                    const sessions = Array.from(this.chatSessions.entries());
                    localStorage.setItem('khai-assistant-chat-sessions', JSON.stringify(sessions));
                } catch (error) {
                    console.error('Error saving chat sessions:', error);
                }
            }

            loadChatSessions() {
                try {
                    const saved = localStorage.getItem('khai-assistant-chat-sessions');
                    if (saved) {
                        const sessions = JSON.parse(saved);
                        this.chatSessions = new Map(sessions);
                    }
                } catch (error) {
                    console.error('Error loading chat sessions:', error);
                }
            }

            handleInputKeydown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            }

            handleImageMode(e) {
                if (this.generateImageBtn.disabled) {
                    e.preventDefault();
                    this.showNotification('Генерация изображений временно недоступна', 'warning');
                } else {
                    this.toggleImageMode();
                }
            }

            handleModelChange(e) {
                if (e.target.value === 'claude-sonnet') {
                    this.showNotification('Claude Sonnet временно недоступен', 'warning');
                    this.modelSelect.value = this.currentModel;
                    return;
                }
                this.changeModel(e.target.value);
            }

            handleBeforeUnload() {
                if (this.isGenerating) {
                    this.stopGeneration();
                }
                
                this.saveCurrentSession();
                this.saveModelPreference();
                this.saveChatSessions();
                this.cleanup();
            }

            setupAutoResize() {
                this.addEventListener(this.userInput, 'input', () => {
                    this.userInput.style.height = 'auto';
                    this.userInput.style.height = Math.min(this.userInput.scrollHeight, 120) + 'px';
                });
            }

            setupVoiceRecognition() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    this.voiceInputBtn.style.display = 'none';
                    return;
                }

                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'ru-RU';

                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.voiceInputBtn.classList.add('voice-input-active');
                        this.showNotification('Слушаю...', 'info');
                    };

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.userInput.value = transcript;
                        this.userInput.focus();
                        this.showNotification('Текст распознан', 'success');
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.showNotification(`Ошибка распознавания: ${event.error}`, 'error');
                        this.isListening = false;
                        this.voiceInputBtn.classList.remove('voice-input-active');
                    };

                    this.recognition.onend = () => {
                        this.isListening = false;
                        this.voiceInputBtn.classList.remove('voice-input-active');
                    };
                } catch (error) {
                    console.error('Error setting up voice recognition:', error);
                    this.voiceInputBtn.style.display = 'none';
                }
            }

            startPlaceholderAnimation() {
                let index = 0;
                let charIndex = 0;
                let isDeleting = false;

                const type = () => {
                    const currentExample = this.placeholderExamples[index];
                    
                    if (isDeleting) {
                        charIndex--;
                    } else {
                        charIndex++;
                    }

                    const currentText = currentExample.substring(0, charIndex);
                    this.userInput.placeholder = currentText + '▌';

                    if (!isDeleting && charIndex === currentExample.length) {
                        isDeleting = true;
                        this.setTimeout(() => {}, 2000);
                    } else if (isDeleting && charIndex === 0) {
                        isDeleting = false;
                        index = (index + 1) % this.placeholderExamples.length;
                    }

                    const typeSpeed = isDeleting ? 50 : 100;
                    this.setTimeout(type, typeSpeed);
                };

                type();
            }

            setTimeout(callback, delay) {
                const timeoutId = setTimeout(() => {
                    this.activeTimeouts.delete(timeoutId);
                    callback();
                }, delay);
                this.activeTimeouts.add(timeoutId);
                return timeoutId;
            }

            changeModel(model) {
                if (!this.modelConfig[model]) {
                    this.showNotification('Неизвестная модель', 'error');
                    return;
                }

                this.currentModel = model;
                const modelInfo = this.modelConfig[model];
                this.showNotification(`Модель изменена на: ${modelInfo.name}`, 'success');
                this.saveModelPreference();
            }

            getModelDisplayName(model) {
                return this.modelConfig[model]?.name || model;
            }

            getModelDescription(model) {
                return this.modelConfig[model]?.description || 'Модель ИИ';
            }

            toggleVoiceInput() {
                if (!this.recognition) {
                    this.showNotification('Голосовой ввод не поддерживается', 'error');
                    return;
                }

                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    try {
                        this.recognition.start();
                    } catch (error) {
                        console.error('Error starting voice recognition:', error);
                        this.showNotification('Ошибка запуска голосового ввода', 'error');
                    }
                }
            }

            toggleVoiceMode() {
                this.isVoiceMode = !this.isVoiceMode;
                const placeholder = this.isVoiceMode 
                    ? "Введите текст для генерации голоса..." 
                    : "Задайте вопрос или опишите изображение...";
                
                this.userInput.placeholder = placeholder;
                this.generateVoiceBtn.classList.toggle('voice-mode-active', this.isVoiceMode);
                
                const icon = this.generateVoiceBtn.querySelector('i');
                icon.className = this.isVoiceMode ? 'ti ti-microphone-off' : 'ti ti-microphone';
                
                this.showNotification(
                    this.isVoiceMode ? 'Режим генерации голоса включен' : 'Режим генерации голоса выключен',
                    'info'
                );
            }

            async handleFileSelect(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                let processedCount = 0;
                const maxFiles = 3;

                for (const file of files) {
                    if (processedCount >= maxFiles) {
                        this.showNotification('Можно прикрепить не более 3 файлов', 'warning');
                        break;
                    }

                    try {
                        if (file.type.startsWith('image/')) {
                            const imageData = await this.processImageFile(file);
                            this.attachedImages.push(imageData);
                            this.showNotification(`Изображение "${file.name}" прикреплено`, 'success');
                            processedCount++;
                        } else if (file.type.startsWith('text/') || file.name.endsWith('.txt')) {
                            const textData = await this.processTextFile(file);
                            this.attachedImages.push(textData);
                            this.showNotification(`Текстовый файл "${file.name}" прикреплен`, 'success');
                            processedCount++;
                        } else {
                            this.showNotification(`Формат файла "${file.name}" не поддерживается`, 'error');
                        }
                    } catch (error) {
                        console.error('Error processing file:', error);
                        this.showNotification(`Ошибка обработки файла: ${file.name}`, 'error');
                    }
                }

                this.renderAttachedFiles();
                event.target.value = '';
                this.handleInputChange();
            }

            processImageFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve({
                            name: file.name,
                            data: e.target.result,
                            type: file.type,
                            size: file.size,
                            fileType: 'image'
                        });
                    };
                    reader.onerror = () => reject(new Error(`Ошибка загрузки изображения: ${file.name}`));
                    reader.readAsDataURL(file);
                });
            }

            async processTextFile(file) {
                try {
                    const blob = await puter.fs.read(file.name);
                    const content = await blob.text();
                    
                    return {
                        name: file.name,
                        data: content,
                        type: file.type,
                        size: file.size,
                        fileType: 'text'
                    };
                } catch (error) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            resolve({
                                name: file.name,
                                data: e.target.result,
                                type: file.type,
                                size: file.size,
                                fileType: 'text'
                            });
                        };
                        reader.onerror = () => reject(new Error(`Ошибка чтения текстового файла: ${file.name}`));
                        reader.readAsText(file);
                    });
                }
            }

            renderAttachedFiles() {
                this.attachedFiles.innerHTML = '';
                
                this.attachedImages.forEach((file, index) => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'attached-file';
                    
                    const icon = file.fileType === 'image' ? 'ti-photo' : 'ti-file-text';
                    const typeLabel = file.fileType === 'image' ? 'Изображение' : 'Текстовый файл';
                    
                    fileElement.innerHTML = `
                        <i class="ti ${icon}"></i>
                        <span>${this.escapeHtml(file.name)} (${typeLabel}, ${this.formatFileSize(file.size)})</span>
                        <button class="remove-file" data-index="${index}">
                            <i class="ti ti-x"></i>
                        </button>
                    `;
                    this.attachedFiles.appendChild(fileElement);
                });

                this.attachedFiles.querySelectorAll('.remove-file').forEach(btn => {
                    this.addEventListener(btn, 'click', (e) => {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'));
                        this.removeAttachedFile(index);
                    });
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            removeAttachedFile(index) {
                if (index < 0 || index >= this.attachedImages.length) return;
                
                const removedFile = this.attachedImages.splice(index, 1)[0];
                this.renderAttachedFiles();
                this.showNotification(`${removedFile.fileType === 'image' ? 'Изображение' : 'Файл'} "${removedFile.name}" удален`, 'info');
                this.handleInputChange();
            }

            addEventListener(element, event, handler) {
                if (!element) return;
                
                const wrappedHandler = (...args) => {
                    try {
                        handler(...args);
                    } catch (error) {
                        console.error(`Error in ${event} handler:`, error);
                        this.showNotification('Произошла ошибка при обработке действия', 'error');
                    }
                };

                element.addEventListener(event, wrappedHandler);
                
                if (!this.activeEventListeners.has(element)) {
                    this.activeEventListeners.set(element, []);
                }
                this.activeEventListeners.get(element).push({ event, handler: wrappedHandler });
            }

            // Очистка ресурсов
            cleanup() {
                this.activeTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
                this.activeTimeouts.clear();

                this.stopSpeech();

                if (this.recognition && this.isListening) {
                    try {
                        this.recognition.stop();
                    } catch (e) {
                        // Игнорируем ошибки при остановке
                    }
                }

                this.removeTypingIndicator();

                this.attachedImages = [];
                
                this.activeEventListeners.forEach((listeners, element) => {
                    if (element && element.removeEventListener) {
                        listeners.forEach(({ event, handler }) => {
                            element.removeEventListener(event, handler);
                        });
                    }
                });
                this.activeEventListeners.clear();
            }
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (typeof puter === 'undefined') {
                    console.warn('Puter.ai не загружен, некоторые функции будут недоступны');
                }
                
                if ('speechSynthesis' in window) {
                    speechSynthesis.getVoices();
                }
                
                new KHAIAssistant();
                
            } catch (error) {
                console.error('Ошибка при инициализации приложения:', error);
                const errorNotification = document.createElement('div');
                errorNotification.className = 'notification error';
                errorNotification.textContent = 'Критическая ошибка при загрузке приложения';
                errorNotification.style.position = 'fixed';
                errorNotification.style.top = '50%';
                errorNotification.style.left = '50%';
                errorNotification.style.transform = 'translate(-50%, -50%)';
                errorNotification.style.zIndex = '10000';
                document.body.appendChild(errorNotification);
            }
        });
    </script>
</body>
</html>
