<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>KHAI ‚Äî –ü–µ—Ä–≤—ã–π –±–µ–ª–æ—Ä—É—Å—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <meta name="description" content="–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π AI-—á–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏ —Ä–µ–∂–∏–º–æ–≤ —Ä–∞–±–æ—Ç—ã">
    <meta name="keywords" content="AI —á–∞—Ç, –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, –ë–µ–ª–∞—Ä—É—Å—å, KHAI, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ">
    <meta name="theme-color" content="#0099ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KHAI">
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <style>
        /* Critical CSS for mobile first */
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: rgba(255,255,255,0.05);
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --accent-primary: #0099ff;
            --accent-error: #ff4444;
            --border-color: rgba(255,255,255,0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
        }
        
        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .app-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-primary), #0066ff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .app-name {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-controls {
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        
        /* Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            max-width: 85%;
            padding: 16px;
            border-radius: 16px;
            line-height: 1.5;
        }
        
        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .message-ai {
            align-self: flex-start;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        /* Input Section */
        .input-section {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
        }
        
        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-area {
            flex: 1;
            position: relative;
        }
        
        .input-area textarea {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 16px 50px 16px 16px;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
            font-family: inherit;
        }
        
        .input-controls {
            position: absolute;
            right: 12px;
            bottom: 12px;
            display: flex;
            gap: 6px;
        }
        
        .input-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--accent-primary), #0066ff);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .send-btn.stop-generation {
            background: var(--accent-error);
        }
        
        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            right: 16px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .nav-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            backdrop-filter: blur(20px);
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            backdrop-filter: blur(20px);
            z-index: 1000;
            max-width: calc(100vw - 32px);
        }
        
        /* Mobile Sidebar */
        .mobile-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: min(320px, 85vw);
            height: 100%;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .mobile-sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .app-header {
                padding: 8px 12px;
            }
            
            .messages-container {
                padding: 12px;
                gap: 12px;
            }
            
            .message {
                max-width: 90%;
                padding: 12px;
            }
            
            .input-section {
                padding: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .app-header {
                padding: 6px 8px;
            }
            
            .logo {
                width: 32px;
                height: 32px;
            }
            
            .app-name {
                font-size: 16px;
            }
            
            .control-btn {
                width: 36px;
                height: 36px;
            }
            
            .messages-container {
                padding: 8px;
                gap: 8px;
            }
            
            .message {
                max-width: 95%;
                padding: 10px;
            }
            
            .input-section {
                padding: 8px;
            }
            
            .input-area textarea {
                padding: 12px 45px 12px 12px;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo-container">
                <button class="control-btn" id="menuToggle">
                    <i class="ti ti-menu-2"></i>
                </button>
                <div class="logo">K</div>
                <div class="app-name">KHAI</div>
            </div>
            
            <div class="header-controls">
                <button class="control-btn" id="themeToggle">
                    <i class="ti ti-moon"></i>
                </button>
                <button class="control-btn" id="modelSelectBtn">
                    <i class="ti ti-brain"></i>
                </button>
            </div>
        </header>

        <!-- Messages Container -->
        <main class="messages-container" id="messagesContainer">
            <!-- Messages will be loaded here -->
        </main>

        <!-- Input Section -->
        <section class="input-section" id="inputSection">
            <div class="input-wrapper">
                <div class="input-area">
                    <textarea 
                        id="userInput" 
                        placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É..." 
                        rows="1"
                    ></textarea>
                    <div class="input-controls">
                        <button class="input-btn" id="voiceInputBtn">
                            <i class="ti ti-microphone"></i>
                        </button>
                        <button class="input-btn" id="clearInputBtn" style="display: none;">
                            <i class="ti ti-x"></i>
                        </button>
                        <button class="send-btn" id="sendBtn">
                            <i class="ti ti-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Mobile Navigation -->
        <div class="mobile-nav" id="chatNavigation">
            <button class="nav-btn" id="scrollToLastAI">
                <i class="ti ti-message-chatbot"></i>
            </button>
            <button class="nav-btn" id="scrollToBottom">
                <i class="ti ti-arrow-down"></i>
            </button>
        </div>

        <!-- Mobile Sidebar -->
        <div class="mobile-sidebar" id="mobileSidebar">
            <div class="sidebar-header">
                <h3>–ú–µ–Ω—é KHAI</h3>
                <button class="control-btn" id="sidebarClose">
                    <i class="ti ti-x"></i>
                </button>
            </div>
            <!-- Sidebar content will be populated dynamically -->
        </div>

        <div class="sidebar-overlay" id="sidebarOverlay"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>
        // KHAI Mobile-First AI Assistant
        class KHAIAssistant {
            constructor() {
                this.initializeElements();
                this.initializeState();
                this.setupMarked();
                this.init();
            }

            initializeElements() {
                // Core elements
                this.messagesContainer = document.getElementById('messagesContainer');
                this.userInput = document.getElementById('userInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.clearInputBtn = document.getElementById('clearInputBtn');
                this.voiceInputBtn = document.getElementById('voiceInputBtn');
                this.themeToggle = document.getElementById('themeToggle');
                this.modelSelectBtn = document.getElementById('modelSelectBtn');
                this.menuToggle = document.getElementById('menuToggle');
                this.sidebarClose = document.getElementById('sidebarClose');
                this.sidebarOverlay = document.getElementById('sidebarOverlay');
                this.mobileSidebar = document.getElementById('mobileSidebar');
                
                // Navigation
                this.chatNavigation = document.getElementById('chatNavigation');
                this.scrollToLastAI = document.getElementById('scrollToLastAI');
                this.scrollToBottom = document.getElementById('scrollToBottom');
            }

            initializeState() {
                this.isGenerating = false;
                this.generationAborted = false;
                this.currentStreamController = null;
                this.activeStreamingMessage = null;
                this.currentTheme = 'dark';
                this.currentModel = 'gpt-4';
                this.isListening = false;
                this.recognition = null;
                this.conversationHistory = [];
                this.autoScrollEnabled = true;
                this.isAtBottom = true;
                this.activeTimeouts = new Set();
                this.activeEventListeners = new Map();

                this.models = {
                    'gpt-4': { name: 'GPT-4 Turbo', icon: 'ti-brain' },
                    'claude-3': { name: 'Claude 3', icon: 'ti-cloud' },
                    'gemini-pro': { name: 'Gemini Pro', icon: 'ti-sparkles' }
                };
            }

            setupMarked() {
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        highlight: (code, lang) => {
                            if (lang && typeof hljs !== 'undefined') {
                                try {
                                    return hljs.highlight(code, { language: lang }).value;
                                } catch (err) {
                                    return code;
                                }
                            }
                            return code;
                        },
                        breaks: true,
                        gfm: true
                    });
                }
            }

            init() {
                try {
                    this.bindEvents();
                    this.setupAutoResize();
                    this.setupVoiceRecognition();
                    this.loadThemePreference();
                    this.loadChatHistory();
                    this.setupScrollTracking();
                    this.showWelcomeMessage();
                    
                    this.showNotification('KHAI –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!', 'success');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'error');
                }
            }

            bindEvents() {
                const events = [
                    [this.sendBtn, 'click', () => this.handleSendButtonClick()],
                    [this.userInput, 'keydown', (e) => this.handleInputKeydown(e)],
                    [this.userInput, 'input', () => this.handleInputChange()],
                    [this.clearInputBtn, 'click', () => this.clearInput()],
                    [this.voiceInputBtn, 'click', () => this.toggleVoiceInput()],
                    [this.themeToggle, 'click', () => this.toggleTheme()],
                    [this.modelSelectBtn, 'click', () => this.showModelSelection()],
                    [this.menuToggle, 'click', () => this.toggleSidebar()],
                    [this.sidebarClose, 'click', () => this.closeSidebar()],
                    [this.sidebarOverlay, 'click', () => this.closeSidebar()],
                    [this.scrollToLastAI, 'click', () => this.scrollToLastAIMessage()],
                    [this.scrollToBottom, 'click', () => this.scrollToBottom(true)],
                    [this.messagesContainer, 'scroll', () => this.handleScroll()],
                    [window, 'beforeunload', () => this.handleBeforeUnload()]
                ];

                events.forEach(([element, event, handler]) => {
                    this.addEventListener(element, event, handler);
                });
            }

            handleSendButtonClick() {
                if (this.isGenerating) {
                    this.stopGeneration();
                } else {
                    this.sendMessage();
                }
            }

            async sendMessage() {
                if (this.isGenerating) {
                    this.showNotification('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', 'warning');
                    return;
                }

                const message = this.userInput.value.trim();
                if (!message) {
                    this.showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
                    return;
                }

                this.isGenerating = true;
                this.generationAborted = false;
                this.updateSendButton(true);

                try {
                    await this.processUserMessage(message);
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.handleError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è', error);
                } finally {
                    if (!this.generationAborted) {
                        this.isGenerating = false;
                        this.updateSendButton(false);
                        this.saveChatHistory();
                    }
                }
            }

            async processUserMessage(message) {
                this.addMessageToChat('user', message);
                this.addToConversationHistory('user', message);
                
                this.userInput.value = '';
                this.autoResizeTextarea(this.userInput);
                this.toggleClearInputButton();

                await this.getAIResponse(message);
            }

            async getAIResponse(userMessage) {
                this.showTypingIndicator();
                
                try {
                    const response = await this.callAIService(userMessage);
                    this.hideTypingIndicator();
                    await this.processAIResponse(response);
                } catch (error) {
                    this.hideTypingIndicator();
                    this.handleError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò', error);
                }
            }

            async callAIService(prompt) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Puter.ai –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                if (typeof puter !== 'undefined' && typeof puter.ai?.chat === 'function') {
                    return await puter.ai.chat(prompt, {
                        model: this.currentModel,
                        systemPrompt: "–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç KHAI. –û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ç–æ—á–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.",
                        stream: true
                    });
                } else {
                    // Fallback –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                    return this.mockAIResponse(prompt);
                }
            }

            async* mockAIResponse(prompt) {
                const responses = [
                    "–ü—Ä–∏–≤–µ—Ç! –Ø KHAI - –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –†–∞–¥ –ø–æ–º–æ—á—å –≤–∞–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏!",
                    "–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ...",
                    "–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å –∏ –≤–æ—Ç —á—Ç–æ –º–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å:"
                ];
                
                const response = responses[Math.floor(Math.random() * responses.length)];
                const words = response.split(' ');
                
                for (const word of words) {
                    if (this.generationAborted) break;
                    await this.delay(100);
                    yield { text: word + ' ' };
                }
            }

            async processAIResponse(response) {
                this.activeStreamingMessage = this.createStreamingMessage();
                this.currentStreamController = response;
                
                let fullResponse = '';
                try {
                    for await (const part of response) {
                        if (this.generationAborted) break;
                        
                        if (part?.text) {
                            fullResponse += part.text;
                            this.updateStreamingMessage(this.activeStreamingMessage, fullResponse);
                            await this.delay(10);
                        }
                    }
                    
                    if (!this.generationAborted) {
                        this.finalizeStreamingMessage(this.activeStreamingMessage, fullResponse);
                        this.addToConversationHistory('assistant', fullResponse);
                    }
                } catch (error) {
                    if (!this.generationAborted) {
                        console.error('Error processing AI response:', error);
                        this.handleError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ –ò–ò', error);
                    }
                } finally {
                    this.activeStreamingMessage = null;
                    this.currentStreamController = null;
                }
            }

            // UI Methods
            updateSendButton(isGenerating) {
                if (isGenerating) {
                    this.sendBtn.classList.add('stop-generation');
                    this.sendBtn.innerHTML = '<i class="ti ti-player-stop"></i>';
                    this.sendBtn.title = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é';
                    this.userInput.disabled = true;
                } else {
                    this.sendBtn.classList.remove('stop-generation');
                    this.sendBtn.innerHTML = '<i class="ti ti-send"></i>';
                    this.sendBtn.title = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
                    this.userInput.disabled = false;
                }
            }

            stopGeneration() {
                if (this.isGenerating && this.currentStreamController) {
                    this.generationAborted = true;
                    this.isGenerating = false;
                    
                    if (this.currentStreamController.abort) {
                        this.currentStreamController.abort();
                    }
                    
                    this.hideTypingIndicator();
                    this.updateSendButton(false);
                    
                    if (this.activeStreamingMessage) {
                        const currentContent = document.querySelector(`#${this.activeStreamingMessage} .streaming-text`)?.innerHTML || '';
                        this.finalizeStreamingMessage(this.activeStreamingMessage, currentContent);
                    }
                    
                    this.showNotification('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
                    this.currentStreamController = null;
                }
            }

            addMessageToChat(role, content) {
                const messageElement = document.createElement('div');
                messageElement.className = `message message-${role}`;
                
                const processedContent = this.processCodeBlocks(content);
                messageElement.innerHTML = `
                    <div class="message-content">${processedContent}</div>
                `;
                
                this.messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
                
                return messageElement;
            }

            processCodeBlocks(content) {
                if (typeof marked !== 'undefined') {
                    return marked.parse(content);
                }
                return content.replace(/\n/g, '<br>');
            }

            createStreamingMessage() {
                const messageElement = document.createElement('div');
                messageElement.className = 'message message-ai streaming-message';
                messageElement.id = 'streaming-' + Date.now();
                
                messageElement.innerHTML = `
                    <div class="message-content streaming-content">
                        <div class="typing-indicator-inline">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span>KHAI –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                        </div>
                        <div class="streaming-text"></div>
                    </div>
                `;
                
                this.messagesContainer.appendChild(messageElement);
                this.scrollToBottom();
                
                return messageElement.id;
            }

            updateStreamingMessage(messageId, content) {
                const messageElement = document.getElementById(messageId);
                if (!messageElement) return;
                
                const streamingText = messageElement.querySelector('.streaming-text');
                if (streamingText) {
                    streamingText.innerHTML = this.processCodeBlocks(content);
                }
                
                if (this.autoScrollEnabled) {
                    this.scrollToBottom();
                }
            }

            finalizeStreamingMessage(messageId, fullContent) {
                const messageElement = document.getElementById(messageId);
                if (!messageElement) return;
                
                messageElement.classList.remove('streaming-message');
                const messageContent = messageElement.querySelector('.message-content');
                messageContent.classList.remove('streaming-content');
                messageContent.innerHTML = this.processCodeBlocks(fullContent);
                
                this.scrollToBottom();
            }

            showTypingIndicator() {
                this.hideTypingIndicator();
                
                const typingElement = document.createElement('div');
                typingElement.className = 'message message-ai typing-indicator';
                typingElement.id = 'typing-indicator';
                
                typingElement.innerHTML = `
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span>KHAI –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                `;
                
                this.messagesContainer.appendChild(typingElement);
                this.scrollToBottom();
                
                return typingElement.id;
            }

            hideTypingIndicator() {
                const typingElement = document.getElementById('typing-indicator');
                if (typingElement) {
                    typingElement.remove();
                }
            }

            // Navigation and Scroll
            setupScrollTracking() {
                this.updateNavigationButtons();
            }

            handleScroll() {
                const container = this.messagesContainer;
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;
                
                this.isAtBottom = scrollHeight - scrollTop - clientHeight < 50;
                this.autoScrollEnabled = this.isAtBottom;
                this.updateNavigationButtons();
            }

            updateNavigationButtons() {
                const aiMessages = document.querySelectorAll('.message-ai:not(.typing-indicator)');
                const hasAIMessages = aiMessages.length > 0;
                
                this.scrollToLastAI.classList.toggle('active', !this.isAtBottom && hasAIMessages);
                this.scrollToLastAI.disabled = !hasAIMessages;
                
                this.scrollToBottom.classList.toggle('active', !this.isAtBottom);
                this.scrollToBottom.disabled = this.isAtBottom;
                
                if (this.isAtBottom) {
                    this.chatNavigation.classList.remove('visible');
                } else {
                    this.chatNavigation.classList.add('visible');
                }
            }

            scrollToLastAIMessage() {
                const aiMessages = document.querySelectorAll('.message-ai:not(.typing-indicator)');
                if (aiMessages.length > 0) {
                    const lastAIMessage = aiMessages[aiMessages.length - 1];
                    lastAIMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            scrollToBottom(force = false) {
                if (force || this.autoScrollEnabled) {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }
            }

            // Input Handling
            handleInputKeydown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.handleSendButtonClick();
                }
            }

            handleInputChange() {
                this.autoResizeTextarea(this.userInput);
                this.toggleClearInputButton();
            }

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            toggleClearInputButton() {
                const hasText = this.userInput.value.trim().length > 0;
                this.clearInputBtn.style.display = hasText ? 'flex' : 'none';
            }

            clearInput() {
                this.userInput.value = '';
                this.autoResizeTextarea(this.userInput);
                this.toggleClearInputButton();
                this.userInput.focus();
            }

            // Voice Input
            setupVoiceRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    this.voiceInputBtn.style.display = 'none';
                    return;
                }

                this.recognition = new webkitSpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = 'ru-RU';

                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.voiceInputBtn.classList.add('active');
                    this.showNotification('–°–ª—É—à–∞—é...', 'info');
                };

                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    this.userInput.value = transcript;
                    this.autoResizeTextarea(this.userInput);
                    this.toggleClearInputButton();
                };

                this.recognition.onerror = (event) => {
                    this.isListening = false;
                    this.voiceInputBtn.classList.remove('active');
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    this.voiceInputBtn.classList.remove('active');
                };
            }

            toggleVoiceInput() {
                if (!this.recognition) return;

                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    this.recognition.start();
                }
            }

            // Theme
            toggleTheme() {
                this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', this.currentTheme);
                localStorage.setItem('khai-theme', this.currentTheme);
            }

            loadThemePreference() {
                const savedTheme = localStorage.getItem('khai-theme') || 'dark';
                this.currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', savedTheme);
            }

            // Sidebar
            toggleSidebar() {
                this.mobileSidebar.classList.toggle('active');
                this.sidebarOverlay.classList.toggle('active');
            }

            closeSidebar() {
                this.mobileSidebar.classList.remove('active');
                this.sidebarOverlay.classList.remove('active');
            }

            // Model Selection
            showModelSelection() {
                // Simplified model selection for mobile
                const modelNames = Object.values(this.models).map(m => m.name);
                const currentModel = this.models[this.currentModel].name;
                
                this.showNotification(`–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å: ${currentModel}`, 'info');
            }

            // Welcome Message
            showWelcomeMessage() {
                if (this.messagesContainer.children.length > 0) return;

                const welcomeMessage = `# üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ KHAI!

**KHAI** - –ø–µ—Ä–≤—ã–π –±–µ–ª–æ—Ä—É—Å—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –ø–µ—Ä–µ–¥–æ–≤—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏:

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
‚Ä¢ **–£–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã** –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–¥–∞** —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
‚Ä¢ **–°—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤** - –æ—Ç–≤–µ—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
‚Ä¢ **–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥** - –≥–æ–≤–æ—Ä–∏—Ç–µ –≤–º–µ—Å—Ç–æ –ø–µ—á–∞—Ç–∏
‚Ä¢ **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚Ä¢ **–¢–µ–º–Ω–∞—è —Ç–µ–º–∞** - –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫

## üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
1. **–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å** –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∏–∂–µ
2. **–ù–∞–∂–º–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å** –∏–ª–∏ Enter –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥** –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
4. **–ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ –º–æ–¥–µ–ª–∏** —á–µ—Ä–µ–∑ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫

**–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!**`;

                this.addMessageToChat('ai', welcomeMessage);
            }

            // Utility Methods
            delay(ms) {
                return new Promise(resolve => this.setTimeout(resolve, ms));
            }

            setTimeout(callback, delay) {
                const timeoutId = setTimeout(() => {
                    this.activeTimeouts.delete(timeoutId);
                    callback();
                }, delay);
                this.activeTimeouts.add(timeoutId);
                return timeoutId;
            }

            addEventListener(element, event, handler) {
                if (!element) return;
                
                const wrappedHandler = (...args) => {
                    try {
                        handler(...args);
                    } catch (error) {
                        console.error(`Error in ${event} handler:`, error);
                    }
                };

                element.addEventListener(event, wrappedHandler);
                
                if (!this.activeEventListeners.has(element)) {
                    this.activeEventListeners.set(element, []);
                }
                this.activeEventListeners.get(element).push({ event, handler: wrappedHandler });
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                this.setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }

            handleError(userMessage, error) {
                console.error(userMessage, error);
                this.showNotification(userMessage, 'error');
            }

            addToConversationHistory(role, content) {
                this.conversationHistory.push({
                    role,
                    content,
                    timestamp: Date.now()
                });
            }

            // Data Management
            saveChatHistory() {
                try {
                    const data = {
                        conversationHistory: this.conversationHistory,
                        currentModel: this.currentModel,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('khai-chat-data', JSON.stringify(data));
                } catch (error) {
                    console.error('Error saving chat history:', error);
                }
            }

            loadChatHistory() {
                try {
                    const saved = localStorage.getItem('khai-chat-data');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.conversationHistory = data.conversationHistory || [];
                        this.currentModel = data.currentModel || 'gpt-4';
                    }
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }

            handleBeforeUnload() {
                this.saveChatHistory();
                this.cleanup();
            }

            cleanup() {
                this.activeTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
                this.activeTimeouts.clear();
                
                this.activeEventListeners.forEach((listeners, element) => {
                    listeners.forEach(({ event, handler }) => {
                        element.removeEventListener(event, handler);
                    });
                });
                this.activeEventListeners.clear();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            window.khaiAssistant = new KHAIAssistant();
        });
    </script>
</body>
</html>
